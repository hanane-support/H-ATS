{% extends "my_base.html" %}

{% block title %}ë„ë©”ì¸ ë° ë³´ì•ˆ - H-ATS Admin{% endblock %}

{% block page_header %}ë„ë©”ì¸ ë° ë³´ì•ˆ ê´€ë¦¬{% endblock %}

{% block content %}

<div class="card domain-security-card">
    <h2 class="card-title">ë„ë©”ì¸ ë° ë³´ì•ˆ ì •ë³´</h2>
    <p class="security-recommendation-text">
        <span class="security-text-span">
            HTTP ëŠ” ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•˜ì§€ ì•Šê³  ì „ì†¡í•˜ì§€ë§Œ, HTTPS ëŠ” SSL/TLS ë¡œ ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•´ ë³´ì•ˆì„ ê°•í™”í•©ë‹ˆë‹¤.
            <br>HTTPS ë³´ì•ˆì„ ì ìš©í•˜ê¸° ìœ„í•´ ë„ë©”ì¸ ë“±ë¡ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
        </span>
    </p>
    <hr class="card-hr">

    <h3 class="section-header">ì„œë²„ ìƒíƒœ</h3>

    <div class="status-box">
        <div class="status-content">
            <p>
                <span class="status-label">HOME IP :</span>
                <span class="status-value-ip">{{ my_ip }}</span>
            </p>

            <p>
                <span class="status-label">VULTR IP :</span>
                <span class="status-value-ip">{{ vultr_ip }}</span>
            </p>

            <p>
                <span class="status-label">ë„ë©”ì¸ :</span>
                <span class="status-value" id="currentDomainDisplay">{{ domain_name | default('ì—†ìŒ') }}</span>
                <button id="domainAccessButton" class="domain-access-button" style="display: none;"
                    data-tooltip="IP ì ‘ì†ì—ì„œ ë¡œê·¸ì•„ì›ƒí•˜ê³  ë„ë©”ì¸ìœ¼ë¡œ ì ‘ì†í•©ë‹ˆë‹¤.&#10;ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì•¼ í•©ë‹ˆë‹¤.">
                    ë„ë©”ì¸ ì ‘ì†
                </button>
            </p>

            <p>
                <span class="status-label">ë³´ì•ˆ :</span>
                <span id="securityStatusDisplay"
                    class="{% if security_status == 'HTTPS' %}status-value-success{% else %}status-value-error{% endif %}">
                    {% if security_status == 'HTTPS' %}
                    ì ìš© (HTTPS)
                    {% else %}
                    ë¯¸ì ìš© (HTTP)
                    {% endif %}
                </span>
            </p>
        </div>
    </div>

    <h3 class="section-header">ë„ë©”ì¸ ê´€ë¦¬ <span class="required-mark">(í•„ìˆ˜)</span></h3>

    <div>
        <input type="text" id="domain-input" placeholder="example.com (ì˜ë¬¸ ë„ë©”ì¸ ê¶Œì¥)" class="domain-input"
            pattern="^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,63}$"
            title="ìœ íš¨í•œ ë„ë©”ì¸ í˜•ì‹ (ì˜ˆ: example.com, sub.example.co.kr)">

        <div class="button-group">
            <button id="registerDomainButton" class="small-button accent-color-bg full-width-button" disabled>ë„ë©”ì¸
                ë“±ë¡</button>

            <button id="releaseDomainButton" class="small-button delete-button full-width-button" disabled>ë„ë©”ì¸
                í•´ì œ</button>
        </div>
    </div>
</div>

<div id="registerDomainModal" class="modal-overlay hidden-modal">
    <div class="modal-content">
        <h3 class="modal-header-danger">ë„ë©”ì¸ ë“±ë¡ í™•ì¸</h3>
        <p class="modal-text" id="registerModalText">
            (<span id="modal-domain-display"></span>) ì„ ë„ë©”ì¸ìœ¼ë¡œ ë“±ë¡í•©ë‹ˆë‹¤. <br><br>
            <span class="modal-text-success">ë“±ë¡ í›„ SSL/TLS ë³´ì•ˆ ì ìš©ì´ ì‹œì‘ë©ë‹ˆë‹¤.</span>
        </p>
        <!-- ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© í‘œì‹œ ì˜ì—­ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
        <div id="registerProgressContainer" class="progress-container hidden-modal">
            <p id="registerProgressText" class="progress-text"></p>
        </div>
        <div class="modal-actions">
            <button id="confirmRegisterDomain" class="small-button accent-color-bg">
                ë“±ë¡
            </button>
            <button id="cancelRegisterDomain" class="small-button secondary-color-bg">
                ì·¨ì†Œ
            </button>
        </div>
    </div>
</div>

<div id="releaseDomainModal" class="modal-overlay hidden-modal">
    <div class="modal-content">
        <h3 class="modal-header-danger">ë„ë©”ì¸ í•´ì œ í™•ì¸</h3>
        <p class="modal-text" id="releaseModalText">
            ë„ë©”ì¸ì„ í•´ì œí•˜ê³  IP (HTTP) ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. <br>
            <br>
            <span class="modal-text-danger">ë³´ì•ˆì´ ì·¨ì•½í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
        </p>
        <!-- ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© í‘œì‹œ ì˜ì—­ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
        <div id="releaseProgressContainer" class="progress-container hidden-modal">
            <p id="releaseProgressText" class="progress-text"></p>
        </div>
        <div class="modal-actions">
            <button id="confirmReleaseDomain" class="small-button delete-button-confirm">
                í•´ì œ
            </button>
            <button id="cancelReleaseDomain" class="small-button secondary-color-bg">
                ì·¨ì†Œ
            </button>
        </div>
    </div>
</div>

<div id="messageModal" class="modal-overlay hidden-modal">
    <div class="modal-content">
        <h3 id="messageModalHeader" class="modal-header-danger"></h3>
        <p id="messageModalText" class="modal-text"></p>
        <div class="modal-actions">
            <button id="closeMessageModal" class="small-button secondary-color-bg">
                í™•ì¸
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head_styles %}
<style>
    .card {
        background-color: var(--header-bg-dark);
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-color-dark);
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .hidden-modal {
        display: none !important;
    }

    .modal-content {
        background-color: var(--header-bg-dark);
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        border: 1px solid var(--border-color-dark);
        max-width: 400px;
        width: 90%;
        text-align: center;
    }

    /* Modal Headers */
    .modal-header-danger {
        color: var(--accent-color);
        font-size: 1.5em;
        /* font-weight: bold; */
        margin-bottom: 30px;
        margin-top: 0;
    }

    /* Success Header for general messages */
    .modal-header-success {
        color: #8BC34A;
        /* status-value-success color */
        font-size: 1.5em;
        /* font-weight: bold; */
        margin-bottom: 30px;
        margin-top: 0;
    }

    #releaseDomainModal .modal-header-danger {
        color: #ff4d4d;
    }

    .modal-text {
        color: var(--text-color-light);
        margin-bottom: 15px;
        line-height: 1.4;
        font-size: 1em;
    }

    .modal-text-success {
        color: #83ff52;
        /* font-weight: bold; */
    }

    .modal-text-danger {
        color: #ff4d4d;
        /* font-weight: bold; */
        margin-bottom: 25px;
        font-size: 1em;
    }

    .modal-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 30px;
    }

    .card-title {
        color: var(--subtitle-color);
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.5em;
    }

    .security-recommendation-text {
        color: var(--text-color-light);
        margin-top: 5px;
        margin-bottom: 15px;
        line-height: 1.4;
    }

    .card-hr {
        border: 0;
        height: 1px;
        background-color: var(--border-color-dark);
        margin-top: 20px;
        margin-bottom: 30px;
    }

    .section-header {
        color: var(--text-color-light);
        margin-top: 35px;
        margin-bottom: 10px;
        font-size: 1.2em;
        /* font-weight: bold; */
    }

    .status-box {
        margin-top: 0;
        padding: 15px;
        border: 1px solid var(--border-color-dark);
        border-radius: 8px;
        background-color: var(--sidebar-bg-dark);
    }

    .status-content p {
        margin: 12px 0;
        line-height: 1.1;
    }

    .status-label {
        /* font-weight: bold; */
        color: var(--text-color-light);
        display: inline-block;
        width: 80px;
    }

    .status-value {
        color: var(--text-color-dark);
    }

    .status-value-ip {
        color: #fffb00;
        font-size: 1.1em;
    }

    .status-value-success {
        color: #22ff00;
    }

    .status-value-error {
        color: #EF5350;
    }

    .required-mark {
        color: #EF5350;
        font-size: 0.9em;
        font-weight: normal;
    }

    /* ë„ë©”ì¸ ì ‘ì† ë²„íŠ¼ */
    .domain-access-button {
        margin-left: 5px;
        padding: 6px 6px;
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 0.8em;
        cursor: pointer;
        transition: background-color 0.3s;
        position: relative;
        vertical-align: middle;
        line-height: 1.0;
        margin-top: -5px;
    }

    .domain-access-button:hover {
        background-color: #0056b3;
    }

    .domain-access-button:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        bottom: -80px;
        background-color: #2a3f5f;
        color: var(--text-color-light);
        padding: 10px 12px;
        border-radius: 6px;
        font-size: 0.85em;
        white-space: pre;
        text-align: center;
        z-index: 1000;
        border: 1px solid var(--border-color-dark);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        line-height: 1.5;
    }

    .domain-access-button:hover::before {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-bottom-color: #2a3f5f;
        z-index: 1001;
    }

    .info-box {
        background-color: var(--sidebar-bg-dark);
        border: 1px solid var(--border-color-dark);
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .info-text {
        color: var(--text-color-light);
        margin: 0 0 10px 0;
        font-size: 0.95em;
    }

    .info-list {
        color: var(--text-color-dark);
        margin: 0;
        padding-left: 20px;
        font-size: 0.9em;
        line-height: 1.6;
    }

    .info-list li {
        margin-bottom: 5px;
    }

    .domain-input {
        width: 100%;
        padding: 12px;
        margin-top: 0;
        margin-bottom: 25px;
        border: 1px solid #444;
        border-radius: 6px;
        background-color: var(--sidebar-bg-dark);
        color: var(--text-color-light);
        font-size: 1em;
        box-sizing: border-box;
    }

    .domain-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 0px;
    }

    .small-button {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        /* font-weight: bold; */
        transition: background-color 0.3s, opacity 0.3s;
        color: var(--text-color-light);
        font-size: 1em;
        flex-grow: 1;
    }

    .small-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .accent-color-bg {
        background-color: var(--accent-color);
    }

    .accent-color-bg:hover {
        background-color: #0056b3;
    }

    .secondary-color-bg {
        background-color: #6c757d;
        color: white;
    }

    .secondary-color-bg:hover {
        background-color: #5a6268;
    }

    .delete-button {
        background-color: #dc3545;
        color: white;
    }

    .delete-button:hover {
        background-color: #c82333;
    }

    .delete-button-confirm {
        background-color: #dc3545;
        color: white;
    }

    .delete-button-confirm:hover {
        background-color: #c82333;
    }

    .full-width-button {
        padding: 10px 20px;
        border-radius: 6px;
    }

    .progress-container {
        margin-top: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background-color: var(--sidebar-bg-dark);
        border: 1px solid var(--border-color-dark);
        border-radius: 6px;
    }

    .progress-text {
        color: #FFD700;
        margin: 0;
        font-size: 1em;
        line-height: 1.6;
        text-align: center;
    }

    .progress-text.success {
        color: #22ff00;
    }

    .progress-text.error {
        color: #EF5350;
    }
</style>
{% endblock %}

{% block page_script %}
<script>
    // Flask/FastAPI í™˜ê²½ì—ì„œ ì‚¬ìš©ë  Base URLì„ ì •ì˜í•©ë‹ˆë‹¤.
    const BASE_URL = '/admin/domain_security';

    // ë“±ë¡ ì„±ê³µ ì‹œ ê°’ì„ ìœ ì§€í•˜ê¸° ìœ„í•œ ë³€ìˆ˜
    let currentDomain = '';

    document.addEventListener('DOMContentLoaded', () => {
        const registerButton = document.getElementById('registerDomainButton');
        const registerModal = document.getElementById('registerDomainModal');
        const confirmRegister = document.getElementById('confirmRegisterDomain');
        const cancelRegister = document.getElementById('cancelRegisterDomain');
        const releaseButton = document.getElementById('releaseDomainButton');
        const releaseModal = document.getElementById('releaseDomainModal');
        const confirmRelease = document.getElementById('confirmReleaseDomain');
        const cancelRelease = document.getElementById('cancelReleaseDomain');
        const domainInput = document.getElementById('domain-input');
        const modalDomainDisplay = document.getElementById('modal-domain-display');

        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ìš”ì†Œ
        const currentDomainDisplay = document.getElementById('currentDomainDisplay');
        const securityStatusDisplay = document.getElementById('securityStatusDisplay');
        const domainAccessButton = document.getElementById('domainAccessButton');

        // VULTR IP ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° (ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ê°’)
        const vultrIpElements = document.querySelectorAll('.status-value-ip');
        const vultrIpDisplay = vultrIpElements.length >= 2 ? vultrIpElements[1] : null;

        // ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ëª¨ë‹¬ ìš”ì†Œ
        const messageModal = document.getElementById('messageModal');
        const messageModalHeader = document.getElementById('messageModalHeader');
        const messageModalText = document.getElementById('messageModalText');
        const closeMessageModal = document.getElementById('closeMessageModal');

        // alert()ë¥¼ ëŒ€ì²´í•˜ëŠ” ë©”ì‹œì§€ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
        const showMessage = (header, text, isSuccess = true) => {
            messageModalHeader.textContent = header;
            messageModalText.innerHTML = text; // HTMLì„ ì‚¬ìš©í•˜ë¯€ë¡œ innerHTML ì‚¬ìš©

            // í—¤ë” ìƒ‰ìƒ/í´ë˜ìŠ¤ ì„¤ì •
            messageModalHeader.classList.remove('modal-header-danger', 'modal-header-success');
            if (isSuccess) {
                messageModalHeader.classList.add('modal-header-success');
            } else {
                messageModalHeader.classList.add('modal-header-danger');
            }

            messageModal.classList.remove('hidden-modal');
        };

        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê¸°ë³¸ ë™ì‘: ëª¨ë‹¬ ìˆ¨ê¹€)
        closeMessageModal.addEventListener('click', () => {
            messageModal.classList.add('hidden-modal');
            // ë“±ë¡ ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë¦¬ìŠ¤ë„ˆê°€ ê±¸ë ¤ìˆë‹¤ë©´ ì œê±°í•©ë‹ˆë‹¤.
            closeMessageModal.removeEventListener('click', handlePostRegisterAction);
        });

        // ----------------------------------------------------
        // ì´ˆê¸° ìƒíƒœ ë™ê¸°í™”: ì„œë²„ì—ì„œ ë Œë”ë§ëœ ë„ë©”ì¸ ê°’ì„ ê°€ì ¸ì™€ ì…ë ¥ í•„ë“œì™€ JS ë³€ìˆ˜ì— ë°˜ì˜í•©ë‹ˆë‹¤.
        const initialDomainText = currentDomainDisplay.textContent.trim();
        if (initialDomainText !== 'ì—†ìŒ' && initialDomainText !== '') {
            currentDomain = initialDomainText;
            domainInput.value = currentDomain;
        }

        // ----------------------------------------------------
        // ë„ë©”ì¸ ì ‘ì† ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ë° ì´ë²¤íŠ¸
        // ----------------------------------------------------

        const updateDomainAccessButton = () => {
            const hasDomain = currentDomain && currentDomain !== '' && currentDomain !== 'ì—†ìŒ';
            const isHttps = securityStatusDisplay.textContent.includes('HTTPS') ||
                securityStatusDisplay.textContent.includes('ì ìš©');

            if (hasDomain && isHttps) {
                domainAccessButton.style.display = 'inline-block';
            } else {
                domainAccessButton.style.display = 'none';
            }
        };

        // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        updateDomainAccessButton();

        // ë„ë©”ì¸ ì ‘ì† ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        domainAccessButton.addEventListener('click', async () => {
            const domain = currentDomain;
            if (!domain || domain === 'ì—†ìŒ') {
                showMessage("ì˜¤ë¥˜", "ë“±ë¡ëœ ë„ë©”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.", false);
                return;
            }

            // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
            try {
                await fetch('/logout', { method: 'POST' });

                // ë„ë©”ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ë¡œê·¸ì¸ í˜ì´ì§€)
                const domainUrl = `https://${domain}/login`;
                window.location.href = domainUrl;
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                // ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨í•´ë„ ë„ë©”ì¸ìœ¼ë¡œ ì´ë™
                const domainUrl = `https://${domain}/login`;
                window.location.href = domainUrl;
            }
        });

        // ----------------------------------------------------

        // VULTR IPëŠ” ì„œë²„ì—ì„œ ë Œë”ë§ë˜ë¯€ë¡œ ë³„ë„ì˜ fetchê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

        // ----------------------------------------------------
        // ë„ë©”ì¸ ìœ íš¨ì„± ê²€ì‚¬ ë° ë²„íŠ¼ í™œì„±í™”
        // ----------------------------------------------------

        const validateInputs = () => {
            const domain = domainInput.value.trim();

            // ë„ë©”ì¸ ìœ íš¨ì„± ê²€ì‚¬
            const isDomainValid = domain && domainInput.checkValidity();

            // ë„ë©”ì¸ ìœ íš¨í•˜ë©´ ë“±ë¡ ë²„íŠ¼ í™œì„±í™”
            if (isDomainValid) {
                registerButton.disabled = false;
            } else {
                registerButton.disabled = true;
            }
        };

        // ë„ë©”ì¸ í•´ì œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        const updateReleaseButtonState = () => {
            // í˜„ì¬ ë„ë©”ì¸ì´ ë“±ë¡ë˜ì–´ ìˆê³  HTTPS ìƒíƒœì¼ ë•Œë§Œ í™œì„±í™”
            const hasDomain = currentDomain && currentDomain !== '' && currentDomain !== 'ì—†ìŒ';
            const isHttps = securityStatusDisplay.textContent.includes('HTTPS') ||
                securityStatusDisplay.textContent.includes('ì ìš©');

            // ì…ë ¥ í•„ë“œë„ í™•ì¸
            const hasDomainInput = domainInput.value.trim() !== '';

            if (hasDomain && isHttps && hasDomainInput) {
                releaseButton.disabled = false;
            } else {
                releaseButton.disabled = true;
            }

            console.log(`ğŸ” í•´ì œ ë²„íŠ¼ ìƒíƒœ: ë„ë©”ì¸=${currentDomain}, HTTPS=${isHttps}, ë„ë©”ì¸ì…ë ¥=${hasDomainInput}, í™œì„±í™”=${!releaseButton.disabled}`);
        };

        // ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œë§ˆë‹¤ ìœ íš¨ì„± ê²€ì‚¬ ë° í•´ì œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        domainInput.addEventListener('input', () => {
            validateInputs();
            updateReleaseButtonState();
        });

        // ì´ˆê¸° ìƒíƒœ ê²€ì‚¬
        validateInputs();
        updateReleaseButtonState();

        // ----------------------------------------------------


        registerButton.addEventListener('click', () => {
            const domain = domainInput.value.trim();

            if (!domain) {
                showMessage("ì˜¤ë¥˜", "ë„ë©”ì¸ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.", false);
                return;
            }

            if (domainInput.checkValidity() === false) {
                showMessage("ì˜¤ë¥˜", "ìœ íš¨í•œ ë„ë©”ì¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.<br>ì˜ˆ: example.com, sub.example.co.kr", false);
                return;
            }

            modalDomainDisplay.textContent = domain;
            registerModal.classList.remove('hidden-modal');
        });

        // ----------------------------------------------------
        // 2. ë„ë©”ì¸ ë“±ë¡ í™•ì¸ ë° SSEë¡œ ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© í‘œì‹œ
        // ----------------------------------------------------

        // ë“±ë¡ ì§„í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸
        let isRegistering = false;

        confirmRegister.addEventListener('click', async () => {
            // ì´ë¯¸ ë“±ë¡ ì§„í–‰ ì¤‘ì´ë©´ ë¦¬í„´ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
            if (isRegistering) {
                console.log('ì´ë¯¸ ë“±ë¡ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
                return;
            }

            const domain = domainInput.value.trim();

            // ëª¨ë‹¬ UI ì—…ë°ì´íŠ¸: í™•ì¸ í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê³  ì§„í–‰ ìƒí™© í‘œì‹œ ì˜ì—­ ë³´ì´ê¸°
            const registerModalText = document.getElementById('registerModalText');
            const registerProgressContainer = document.getElementById('registerProgressContainer');
            const registerProgressText = document.getElementById('registerProgressText');

            registerModalText.classList.add('hidden-modal');
            registerProgressContainer.classList.remove('hidden-modal');
            registerProgressText.textContent = 'â³ ë„ë©”ì¸ ë“±ë¡ì„ ì‹œì‘í•©ë‹ˆë‹¤...';
            registerProgressText.className = 'progress-text'; // ê¸°ë³¸ ìƒ‰ìƒ (ê³¨ë“œ)

            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½: ë“±ë¡ ë²„íŠ¼ ë¹„í™œì„±í™”
            confirmRegister.disabled = true;

            // ë“±ë¡ ì§„í–‰ í”Œë˜ê·¸ ì„¤ì •
            isRegistering = true;

            try {
                // POSTë¡œ SSE ìŠ¤íŠ¸ë¦¼ ìš”ì²­ (ë„ë©”ì¸ë§Œ ì „ì†¡)
                const response = await fetch(`${BASE_URL}/apply_security`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: domain
                    })
                });

                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }

                // SSE ìŠ¤íŠ¸ë¦¼ ì½ê¸°
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');

                    // ë§ˆì§€ë§‰ ë¶ˆì™„ì „í•œ ë¼ì¸ì€ ë²„í¼ì— ë³´ê´€
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6).trim();
                            if (!jsonStr) continue;

                            try {
                                const data = JSON.parse(jsonStr);

                                // ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                                if (data.status === 'progress') {
                                    // ëª¨ë‹¬ ë‚´ ì§„í–‰ ìƒí™© í‘œì‹œ
                                    registerProgressText.textContent = `${data.message}`;
                                    registerProgressText.className = 'progress-text'; // ê³¨ë“œ ìƒ‰ìƒ

                                    console.log(`[ì§„í–‰ ì¤‘] ${data.message} (${data.step})`);
                                } else if (data.status === 'success') {
                                    // ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                                    currentDomainDisplay.textContent = domain;
                                    currentDomain = domain;
                                    domainInput.value = currentDomain;

                                    // ì„œë²„ ìƒíƒœëŠ” ìµœì¢… ê²°ê³¼ë§Œ í‘œì‹œ
                                    securityStatusDisplay.textContent = 'ì ìš© (HTTPS)';
                                    securityStatusDisplay.classList.remove('status-value-error');
                                    securityStatusDisplay.classList.add('status-value-success');

                                    // ëª¨ë‹¬ì— ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                                    registerProgressText.textContent = 'ë„ë©”ì¸ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                                    registerProgressText.className = 'progress-text success'; // ë…¹ìƒ‰

                                    // ë„ë©”ì¸ ë“±ë¡ ì„±ê³µ ì‹œ í•´ì œ ë²„íŠ¼ í™œì„±í™”
                                    updateReleaseButtonState();

                                    // ë„ë©”ì¸ ì ‘ì† ë²„íŠ¼ í‘œì‹œ
                                    updateDomainAccessButton();

                                    // í™•ì¸ ë²„íŠ¼ í™œì„±í™” (íŒŒë€ìƒ‰)
                                    confirmRegister.textContent = 'í™•ì¸';
                                    confirmRegister.disabled = false;
                                    confirmRegister.classList.remove('accent-color-bg');
                                    confirmRegister.classList.add('accent-color-bg');

                                    // ë“±ë¡ ì™„ë£Œ - í”Œë˜ê·¸ í•´ì œ ë° ë‹¤ìŒ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸° ì¤€ë¹„
                                    isRegistering = false;

                                    console.log(`[ì„±ê³µ] ${data.message}`);
                                    break;
                                } else if (data.status === 'error') {
                                    // ì‹¤íŒ¨ ì‹œ - ì…ë ¥ í•„ë“œ ê°’ ìœ ì§€ (currentDomain, currentEmail ì—…ë°ì´íŠ¸ ì•ˆ í•¨)
                                    securityStatusDisplay.textContent = 'ë¯¸ì ìš© (HTTP)';
                                    securityStatusDisplay.classList.remove('status-value-success');
                                    securityStatusDisplay.classList.add('status-value-error');

                                    // ëª¨ë‹¬ì— ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
                                    registerProgressText.textContent = `ë“±ë¡ ì‹¤íŒ¨: ${data.message}`;
                                    registerProgressText.className = 'progress-text error'; // ë¹¨ê°„ìƒ‰

                                    // ì…ë ¥ í•„ë“œëŠ” ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ ê·¸ëŒ€ë¡œ ìœ ì§€
                                    // (domainInput.value ë³€ê²½ ì•ˆ í•¨)

                                    // í™•ì¸ ë²„íŠ¼ í™œì„±í™”
                                    confirmRegister.textContent = 'í™•ì¸';
                                    confirmRegister.disabled = false;

                                    // ë“±ë¡ ì‹¤íŒ¨ - í”Œë˜ê·¸ í•´ì œ ë° ë‹¤ìŒ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸° ì¤€ë¹„
                                    isRegistering = false;

                                    console.error(`[ì‹¤íŒ¨] ${data.message}`);
                                    break;
                                } else if (data.status === 'warning') {
                                    // ê²½ê³  ë©”ì‹œì§€
                                    console.warn(`[ê²½ê³ ] ${data.message}`);
                                }
                            } catch (parseError) {
                                console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", parseError, "ì›ë³¸:", jsonStr);
                            }
                        }
                    }
                }

            } catch (error) {
                // ëª¨ë‹¬ì— ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                registerProgressText.textContent = `âŒ ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                registerProgressText.className = 'progress-text error';

                console.error("Fetch ì˜¤ë¥˜:", error);

                // ì˜¤ë¥˜ ì‹œ ìƒíƒœ ë³µêµ¬
                securityStatusDisplay.textContent = 'ë¯¸ì ìš© (HTTP)';
                securityStatusDisplay.classList.remove('status-value-success');
                securityStatusDisplay.classList.add('status-value-error');

                // ì…ë ¥ í•„ë“œëŠ” ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ ê·¸ëŒ€ë¡œ ìœ ì§€
                // (domainInput.value ë³€ê²½ ì•ˆ í•¨)

                // í™•ì¸ ë²„íŠ¼ í™œì„±í™”
                confirmRegister.textContent = 'í™•ì¸';
                confirmRegister.disabled = false;

                // í†µì‹  ì˜¤ë¥˜ - í”Œë˜ê·¸ í•´ì œ ë° ë‹¤ìŒ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸° ì¤€ë¹„
                isRegistering = false;
            }
        });

        // ì„±ê³µ/ì‹¤íŒ¨ í›„ 'í™•ì¸' ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•œ ë³„ë„ ë¦¬ìŠ¤ë„ˆ
        confirmRegister.addEventListener('click', (event) => {
            // ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆê³ , ë²„íŠ¼ í…ìŠ¤íŠ¸ê°€ 'í™•ì¸'ì¼ ë•Œë§Œ ëª¨ë‹¬ ë‹«ê¸°
            if (!isRegistering && confirmRegister.textContent === 'í™•ì¸') {
                // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€ (ì¤‘ìš”!)
                event.stopImmediatePropagation();

                // ëª¨ë‹¬ ë‹«ê³  ì´ˆê¸°í™”
                registerModal.classList.add('hidden-modal');
                registerModalText.classList.remove('hidden-modal');
                registerProgressContainer.classList.add('hidden-modal');
                confirmRegister.textContent = 'ë“±ë¡';
                confirmRegister.disabled = false;

                console.log('ëª¨ë‹¬ ë‹«ê¸° ì™„ë£Œ');
            }
        }, true); // ìº¡ì²˜ ë‹¨ê³„ì—ì„œ ì‹¤í–‰

        // ----------------------------------------------------
        // ë„ë©”ì¸ ë“±ë¡ ì·¨ì†Œ ë²„íŠ¼
        // ----------------------------------------------------

        cancelRegister.addEventListener('click', () => {
            // ëª¨ë‹¬ ë‹«ê³  ì´ˆê¸°í™”
            registerModal.classList.add('hidden-modal');

            // ì§„í–‰ ì¤‘ì´ì—ˆë‹¤ë©´ ì´ˆê¸°í™”
            const registerModalText = document.getElementById('registerModalText');
            const registerProgressContainer = document.getElementById('registerProgressContainer');

            registerModalText.classList.remove('hidden-modal');
            registerProgressContainer.classList.add('hidden-modal');
            confirmRegister.textContent = 'ë“±ë¡';
            confirmRegister.disabled = false;

            console.log('ë“±ë¡ ëª¨ë‹¬ ì·¨ì†Œë¨');
        });

        // ----------------------------------------------------


        releaseButton.addEventListener('click', () => {
            // í˜„ì¬ ë“±ë¡ëœ ë„ë©”ì¸ í™•ì¸
            const registeredDomain = currentDomainDisplay.textContent.trim();

            if (registeredDomain === 'ì—†ìŒ' || !registeredDomain) {
                showMessage("ì˜¤ë¥˜", "í•´ì œí•  ë„ë©”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë¨¼ì € ë„ë©”ì¸ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.", false);
                return;
            }

            releaseModal.classList.remove('hidden-modal');
        });

        // í•´ì œ ì§„í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸
        let isReleasing = false;

        confirmRelease.addEventListener('click', async () => {
            // ì´ë¯¸ í•´ì œ ì§„í–‰ ì¤‘ì´ë©´ ë¦¬í„´ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€)
            if (isReleasing) {
                console.log('ì´ë¯¸ í•´ì œê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
                return;
            }

            // VULTR IP ê°€ì ¸ì˜¤ê¸°
            const ipAddress = vultrIpDisplay ? vultrIpDisplay.textContent.trim() : '{{ vultr_ip }}';

            if (!ipAddress || ipAddress === 'í™•ì¸ ì¤‘...' || ipAddress === '') {
                showMessage("ì˜¤ë¥˜", "ìœ íš¨í•œ IP ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", false);
                return;
            }

            console.log(`ğŸ” ë„ë©”ì¸ í•´ì œ ìš”ì²­: VULTR IP = ${ipAddress}`);

            // ëª¨ë‹¬ UI ì—…ë°ì´íŠ¸: í™•ì¸ í…ìŠ¤íŠ¸ ìˆ¨ê¸°ê³  ì§„í–‰ ìƒí™© í‘œì‹œ ì˜ì—­ ë³´ì´ê¸°
            const releaseModalText = document.getElementById('releaseModalText');
            const releaseProgressContainer = document.getElementById('releaseProgressContainer');
            const releaseProgressText = document.getElementById('releaseProgressText');

            releaseModalText.classList.add('hidden-modal');
            releaseProgressContainer.classList.remove('hidden-modal');
            releaseProgressText.textContent = 'â³ ë„ë©”ì¸ í•´ì œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...';
            releaseProgressText.className = 'progress-text'; // ê¸°ë³¸ ìƒ‰ìƒ (ê³¨ë“œ)

            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½: í•´ì œ ë²„íŠ¼ ë¹„í™œì„±í™”
            confirmRelease.disabled = true;

            // í•´ì œ ì§„í–‰ í”Œë˜ê·¸ ì„¤ì •
            isReleasing = true;

            try {
                // POSTë¡œ SSE ìŠ¤íŠ¸ë¦¼ ìš”ì²­
                const response = await fetch(`${BASE_URL}/release_security`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ip: ipAddress })
                });

                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');

                    // ë§ˆì§€ë§‰ ë¶ˆì™„ì „í•œ ë¼ì¸ì€ ë²„í¼ì— ë³´ê´€
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6).trim();
                            if (!jsonStr) continue;

                            try {
                                const data = JSON.parse(jsonStr);

                                // ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                                if (data.status === 'progress') {
                                    // ëª¨ë‹¬ ë‚´ ì§„í–‰ ìƒí™© í‘œì‹œ
                                    releaseProgressText.textContent = `${data.message}`;
                                    releaseProgressText.className = 'progress-text'; // ê³¨ë“œ ìƒ‰ìƒ

                                    console.log(`[ì§„í–‰ ì¤‘] ${data.message} (${data.step})`);
                                } else if (data.status === 'success') {
                                    // ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                                    currentDomainDisplay.textContent = 'ì—†ìŒ';
                                    currentDomain = '';
                                    domainInput.value = '';

                                    // ì„œë²„ ìƒíƒœëŠ” ìµœì¢… ê²°ê³¼ë§Œ í‘œì‹œ
                                    securityStatusDisplay.textContent = 'ë¯¸ì ìš© (HTTP)';
                                    securityStatusDisplay.classList.remove('status-value-success');
                                    securityStatusDisplay.classList.add('status-value-error');

                                    // ëª¨ë‹¬ì— ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                                    releaseProgressText.textContent = 'ë„ë©”ì¸ í•´ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                                    releaseProgressText.className = 'progress-text success'; // ë…¹ìƒ‰

                                    // ë„ë©”ì¸ í•´ì œ ì„±ê³µ ì‹œ í•´ì œ ë²„íŠ¼ ë¹„í™œì„±í™”
                                    updateReleaseButtonState();

                                    // ë„ë©”ì¸ ì ‘ì† ë²„íŠ¼ ìˆ¨ê¹€
                                    updateDomainAccessButton();

                                    // í™•ì¸ ë²„íŠ¼ í™œì„±í™” (íŒŒë€ìƒ‰)
                                    confirmRelease.textContent = 'í™•ì¸';
                                    confirmRelease.disabled = false;
                                    confirmRelease.classList.remove('delete-button-confirm');
                                    confirmRelease.classList.add('accent-color-bg');

                                    // í•´ì œ ì™„ë£Œ - í”Œë˜ê·¸ í•´ì œ ë° ë‹¤ìŒ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸° ì¤€ë¹„
                                    isReleasing = false;

                                    console.log(`[ì„±ê³µ] ${data.message}`);
                                    break;
                                } else if (data.status === 'error') {
                                    // ì‹¤íŒ¨ ì‹œ
                                    // ëª¨ë‹¬ì— ì‹¤íŒ¨ ë©”ì‹œì§€ í‘œì‹œ
                                    releaseProgressText.textContent = `í•´ì œ ì‹¤íŒ¨: ${data.message}`;
                                    releaseProgressText.className = 'progress-text error'; // ë¹¨ê°„ìƒ‰

                                    // í™•ì¸ ë²„íŠ¼ í™œì„±í™”
                                    confirmRelease.textContent = 'í™•ì¸';
                                    confirmRelease.disabled = false;

                                    // í•´ì œ ì‹¤íŒ¨ - í”Œë˜ê·¸ í•´ì œ ë° ë‹¤ìŒ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸° ì¤€ë¹„
                                    isReleasing = false;

                                    console.error(`[ì‹¤íŒ¨] ${data.message}`);
                                    break;
                                } else if (data.status === 'warning') {
                                    // ê²½ê³  ë©”ì‹œì§€
                                    console.warn(`[ê²½ê³ ] ${data.message}`);
                                }
                            } catch (parseError) {
                                console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", parseError, "ì›ë³¸:", jsonStr);
                            }
                        }
                    }
                }

            } catch (error) {
                // ëª¨ë‹¬ì— ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                releaseProgressText.textContent = `âŒ ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                releaseProgressText.className = 'progress-text error';

                console.error("Fetch ì˜¤ë¥˜:", error);

                // í™•ì¸ ë²„íŠ¼ í™œì„±í™”
                confirmRelease.textContent = 'í™•ì¸';
                confirmRelease.disabled = false;

                // í†µì‹  ì˜¤ë¥˜ - í”Œë˜ê·¸ í•´ì œ ë° ë‹¤ìŒ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸° ì¤€ë¹„
                isReleasing = false;
            }
        });

        // ì„±ê³µ/ì‹¤íŒ¨ í›„ 'í™•ì¸' ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•œ ë³„ë„ ë¦¬ìŠ¤ë„ˆ
        confirmRelease.addEventListener('click', (event) => {
            // í•´ì œê°€ ì™„ë£Œë˜ì—ˆê³ , ë²„íŠ¼ í…ìŠ¤íŠ¸ê°€ 'í™•ì¸'ì¼ ë•Œë§Œ ëª¨ë‹¬ ë‹«ê¸°
            if (!isReleasing && confirmRelease.textContent === 'í™•ì¸') {
                // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€ (ì¤‘ìš”!)
                event.stopImmediatePropagation();

                // ëª¨ë‹¬ ë‹«ê³  ì´ˆê¸°í™”
                releaseModal.classList.add('hidden-modal');
                releaseModalText.classList.remove('hidden-modal');
                releaseProgressContainer.classList.add('hidden-modal');
                confirmRelease.textContent = 'í•´ì œ';
                confirmRelease.disabled = false;
                confirmRelease.classList.remove('accent-color-bg');
                confirmRelease.classList.add('delete-button-confirm');

                console.log('í•´ì œ ëª¨ë‹¬ ë‹«ê¸° ì™„ë£Œ');
            }
        }, true); // ìº¡ì²˜ ë‹¨ê³„ì—ì„œ ì‹¤í–‰

        // ----------------------------------------------------
        // ë„ë©”ì¸ í•´ì œ ì·¨ì†Œ ë²„íŠ¼
        // ----------------------------------------------------

        cancelRelease.addEventListener('click', () => {
            // ëª¨ë‹¬ ë‹«ê³  ì´ˆê¸°í™”
            releaseModal.classList.add('hidden-modal');

            // ì§„í–‰ ì¤‘ì´ì—ˆë‹¤ë©´ ì´ˆê¸°í™”
            const releaseModalText = document.getElementById('releaseModalText');
            const releaseProgressContainer = document.getElementById('releaseProgressContainer');

            releaseModalText.classList.remove('hidden-modal');
            releaseProgressContainer.classList.add('hidden-modal');
            confirmRelease.textContent = 'í•´ì œ';
            confirmRelease.disabled = false;
            confirmRelease.classList.remove('accent-color-bg');
            confirmRelease.classList.add('delete-button-confirm');

            console.log('í•´ì œ ëª¨ë‹¬ ì·¨ì†Œë¨');
        });

        // ----------------------------------------------------

        console.log("ë„ë©”ì¸ ë° ë³´ì•ˆ ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œë¨.");
    });
</script>
{% endblock %}