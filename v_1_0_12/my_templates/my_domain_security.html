{% extends "my_base.html" %}

{% block title %}도메인 및 보안 - H-ATS Admin{% endblock %}

{% block page_header %}도메인 및 보안 관리{% endblock %}

{% block content %}

<div class="card domain-security-card">
    <h2 class="card-title">도메인 및 보안 정보</h2>
    <p class="security-recommendation-text">
        <span class="security-text-span">
            HTTP 는 데이터를 암호화하지 않고 전송하지만, HTTPS 는 SSL/TLS 로 데이터를 암호화해 보안을 강화합니다.
            <br>HTTPS 보안을 적용하기 위해 도메인 등록을 권장합니다.
        </span>
    </p>
    <hr class="card-hr">

    <h3 class="section-header">서버 상태</h3>

    <div class="status-box">
        <div class="status-content">
            <p>
                <span class="status-label">IP :</span>
                <span class="status-value-ip" id="actualIpDisplay">IP 주소 확인 중...</span>
            </p>

            <p>
                <span class="status-label">도메인 :</span>
                <span class="status-value" id="currentDomainDisplay">{{ domain_name | default('없음') }}</span>
            </p>

            <p>
                <span class="status-label">보안 :</span>
                <span id="securityStatusDisplay"
                    class="{% if security_status == 'HTTPS' %}status-value-success{% else %}status-value-error{% endif %}">
                    {% if security_status == 'HTTPS' %}
                    적용 (HTTPS)
                    {% else %}
                    미적용 (HTTP)
                    {% endif %}
                </span>
            </p>
        </div>
    </div>

    <h3 class="section-header">이메일 등록 <span class="required-mark">(필수)</span></h3>

    <div class="info-box">
        <p class="info-text">
            <strong>이메일을 등록해야 하는 이유:</strong>
        </p>
        <ul class="info-list">
            <li>인증서 만료 알림 수신 (30일 전, 7일 전)</li>
            <li>ACME 계정 복구 및 관리</li>
            <li>보안 취약점 발견 시 긴급 연락</li>
        </ul>
    </div>

    <div>
        <input type="email" id="email-input" placeholder="admin@example.com" class="email-input"
            title="유효한 이메일 주소 (예: admin@yourdomain.com)">
    </div>

    <h3 class="section-header">도메인 관리 <span class="required-mark">(필수)</span></h3>

    <div>
        <input type="text" id="domain-input" placeholder="example.com (영문 도메인 권장)" class="domain-input"
            pattern="^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,63}$"
            title="유효한 도메인 형식 (예: example.com, sub.example.co.kr)">

        <div class="button-group">
            <button id="registerDomainButton" class="small-button accent-color-bg full-width-button" disabled>도메인 등록</button>

            <button id="releaseDomainButton" class="small-button delete-button full-width-button">도메인 해제</button>
        </div>
    </div>
</div>

<div id="registerDomainModal" class="modal-overlay hidden-modal">
    <div class="modal-content">
        <h3 class="modal-header-danger">도메인 등록 확인</h3>
        <p class="modal-text">
            (<span id="modal-domain-display"></span>) 을 도메인으로 등록합니다. <br><br>
            <span class="modal-text-success">등록 후 SSL/TLS 보안 적용이 시작됩니다.</span>
        </p>
        <div class="modal-actions">
            <button id="confirmRegisterDomain" class="small-button accent-color-bg">
                등록
            </button>
            <button id="cancelRegisterDomain" class="small-button secondary-color-bg">
                취소
            </button>
        </div>
    </div>
</div>

<div id="releaseDomainModal" class="modal-overlay hidden-modal">
    <div class="modal-content">
        <h3 class="modal-header-danger">도메인 해제 확인</h3>
        <p class="modal-text">
            도메인을 해제하고 IP (HTTP) 로 사용합니다. <br>
        </p>
        <p class="modal-text-danger">
            보안이 취약해질 수 있습니다.
        </p>
        <div class="modal-actions">
            <button id="confirmReleaseDomain" class="small-button delete-button-confirm">
                해제
            </button>
            <button id="cancelReleaseDomain" class="small-button secondary-color-bg">
                취소
            </button>
        </div>
    </div>
</div>

<div id="messageModal" class="modal-overlay hidden-modal">
    <div class="modal-content">
        <h3 id="messageModalHeader" class="modal-header-danger"></h3>
        <p id="messageModalText" class="modal-text"></p>
        <div class="modal-actions">
            <button id="closeMessageModal" class="small-button secondary-color-bg">
                확인
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head_styles %}
<style>
    .card {
        background-color: var(--header-bg-dark);
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-color-dark);
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .hidden-modal {
        display: none !important;
    }

    .modal-content {
        background-color: var(--header-bg-dark);
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        border: 1px solid var(--border-color-dark);
        max-width: 400px;
        width: 90%;
        text-align: center;
    }

    /* Modal Headers */
    .modal-header-danger {
        color: var(--accent-color);
        font-size: 1.5em;
        /* font-weight: bold; */
        margin-bottom: 30px;
        margin-top: 0;
    }

    /* Success Header for general messages */
    .modal-header-success {
        color: #8BC34A;
        /* status-value-success color */
        font-size: 1.5em;
        /* font-weight: bold; */
        margin-bottom: 30px;
        margin-top: 0;
    }

    #releaseDomainModal .modal-header-danger {
        color: #ff4d4d;
    }

    .modal-text {
        color: var(--text-color-light);
        margin-bottom: 15px;
        line-height: 1.4;
        font-size: 1em;
    }

    .modal-text-success {
        color: #83ff52;
        /* font-weight: bold; */
    }

    .modal-text-danger {
        color: #ff4d4d;
        /* font-weight: bold; */
        margin-bottom: 25px;
        font-size: 1em;
    }

    .modal-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 30px;
    }

    .card-title {
        color: var(--subtitle-color);
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.5em;
    }

    .security-recommendation-text {
        color: var(--text-color-light);
        margin-top: 5px;
        margin-bottom: 15px;
        line-height: 1.4;
    }

    .card-hr {
        border: 0;
        height: 1px;
        background-color: var(--border-color-dark);
        margin-top: 20px;
        margin-bottom: 30px;
    }

    .section-header {
        color: var(--text-color-light);
        margin-top: 35px;
        margin-bottom: 10px;
        font-size: 1.2em;
        /* font-weight: bold; */
    }

    .status-box {
        margin-top: 0;
        padding: 20px;
        border: 1px solid var(--border-color-dark);
        border-radius: 8px;
        background-color: var(--sidebar-bg-dark);
    }

    .status-content p {
        margin: 12px 0;
        line-height: 1.2;
    }

    .status-label {
        /* font-weight: bold; */
        color: var(--text-color-light);
        display: inline-block;
        width: 80px;
    }

    .status-value {
        color: var(--text-color-dark);
    }

    .status-value-ip {
        color: #FFEB3B;
        font-size: 1.1em;
    }

    .status-value-success {
        color: #8BC34A;
    }

    .status-value-error {
        color: #EF5350;
    }

    .required-mark {
        color: #EF5350;
        font-size: 0.9em;
        font-weight: normal;
    }

    .info-box {
        background-color: #1a2332;
        border: 1px solid #2a3f5f;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .info-text {
        color: var(--text-color-light);
        margin: 0 0 10px 0;
        font-size: 0.95em;
    }

    .info-list {
        color: var(--text-color-dark);
        margin: 0;
        padding-left: 20px;
        font-size: 0.9em;
        line-height: 1.6;
    }

    .info-list li {
        margin-bottom: 5px;
    }

    .email-input {
        width: 100%;
        padding: 12px;
        margin-top: 0;
        margin-bottom: 25px;
        border: 1px solid #444;
        border-radius: 6px;
        background-color: var(--sidebar-bg-dark);
        color: var(--text-color-light);
        font-size: 1em;
        box-sizing: border-box;
    }

    .email-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .domain-input {
        width: 100%;
        padding: 12px;
        margin-top: 0;
        margin-bottom: 25px;
        border: 1px solid #444;
        border-radius: 6px;
        background-color: var(--sidebar-bg-dark);
        color: var(--text-color-light);
        font-size: 1em;
        box-sizing: border-box;
    }

    .domain-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 0px;
    }

    .small-button {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        /* font-weight: bold; */
        transition: background-color 0.3s, opacity 0.3s;
        color: var(--text-color-light);
        font-size: 1em;
        flex-grow: 1;
    }

    .small-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .accent-color-bg {
        background-color: var(--accent-color);
    }

    .accent-color-bg:hover {
        background-color: #0056b3;
    }

    .secondary-color-bg {
        background-color: #6c757d;
        color: white;
    }

    .secondary-color-bg:hover {
        background-color: #5a6268;
    }

    .delete-button {
        background-color: #dc3545;
        color: white;
    }

    .delete-button:hover {
        background-color: #c82333;
    }

    .delete-button-confirm {
        background-color: #dc3545;
        color: white;
    }

    .delete-button-confirm:hover {
        background-color: #c82333;
    }

    .full-width-button {
        padding: 10px 20px;
        border-radius: 6px;
    }
</style>
{% endblock %}

{% block page_script %}
<script>
    // Flask/FastAPI 환경에서 사용될 Base URL을 정의합니다.
    const BASE_URL = '/admin/domain_security';

    // 등록 성공 시 값을 유지하기 위한 변수
    let currentDomain = '';

    document.addEventListener('DOMContentLoaded', () => {
        const registerButton = document.getElementById('registerDomainButton');
        const registerModal = document.getElementById('registerDomainModal');
        const confirmRegister = document.getElementById('confirmRegisterDomain');
        const cancelRegister = document.getElementById('cancelRegisterDomain');
        const releaseButton = document.getElementById('releaseDomainButton');
        const releaseModal = document.getElementById('releaseDomainModal');
        const confirmRelease = document.getElementById('confirmReleaseDomain');
        const cancelRelease = document.getElementById('cancelReleaseDomain');
        const emailInput = document.getElementById('email-input');
        const domainInput = document.getElementById('domain-input');
        const modalDomainDisplay = document.getElementById('modal-domain-display');

        // 상태 표시 업데이트를 위한 요소
        const actualIpDisplay = document.getElementById('actualIpDisplay');
        const currentDomainDisplay = document.getElementById('currentDomainDisplay');
        const securityStatusDisplay = document.getElementById('securityStatusDisplay');

        // 커스텀 메시지 모달 요소
        const messageModal = document.getElementById('messageModal');
        const messageModalHeader = document.getElementById('messageModalHeader');
        const messageModalText = document.getElementById('messageModalText');
        const closeMessageModal = document.getElementById('closeMessageModal');

        // alert()를 대체하는 메시지 모달 표시 함수
        const showMessage = (header, text, isSuccess = true) => {
            messageModalHeader.textContent = header;
            messageModalText.innerHTML = text; // HTML을 사용하므로 innerHTML 사용

            // 헤더 색상/클래스 설정
            messageModalHeader.classList.remove('modal-header-danger', 'modal-header-success');
            if (isSuccess) {
                messageModalHeader.classList.add('modal-header-success');
            } else {
                messageModalHeader.classList.add('modal-header-danger');
            }

            messageModal.classList.remove('hidden-modal');
        };

        // 모달 닫기 이벤트 리스너 (기본 동작: 모달 숨김)
        closeMessageModal.addEventListener('click', () => {
            messageModal.classList.add('hidden-modal');
            // 등록 성공 시 페이지 새로고침 리스너가 걸려있다면 제거합니다.
            closeMessageModal.removeEventListener('click', handlePostRegisterAction);
        });

        // ----------------------------------------------------
        // 초기 상태 동기화: 서버에서 렌더링된 도메인 값을 가져와 입력 필드와 JS 변수에 반영합니다.
        const initialDomainText = currentDomainDisplay.textContent.trim();
        if (initialDomainText !== '없음' && initialDomainText !== '') {
            currentDomain = initialDomainText;
            domainInput.value = currentDomain;
        }
        // ----------------------------------------------------

        // ----------------------------------------------------
        // 1. 공인 IP 주소를 비동기적으로 가져와 표시하는 로직
        // ----------------------------------------------------
        const fetchPublicIp = async () => {
            try {
                // 통신 오류 문제를 해결하기 위해 텍스트 기반 API로 변경 유지
                const response = await fetch('https://ifconfig.me/ip');
                if (!response.ok) {
                    throw new Error(`IP API 응답 오류: ${response.status}`);
                }

                const ip = (await response.text()).trim();

                if (ip && (ip.match(/\./g) || ip.match(/:/g))) {
                    actualIpDisplay.textContent = ip;
                } else {
                    actualIpDisplay.textContent = 'IP 주소 형식 오류';
                }
            } catch (error) {
                console.error("공인 IP 주소를 가져오는 중 오류 발생:", error);
                actualIpDisplay.innerHTML = 'IP 주소 확인 실패 (<a href="https://www.whatismyip.com/" target="_blank" style="color:#FFEB3B; text-decoration: underline;">외부에서 확인</a>)';
            }
        };

        fetchPublicIp();

        // ----------------------------------------------------
        // 이메일 및 도메인 유효성 검사 및 버튼 활성화
        // ----------------------------------------------------

        const validateInputs = () => {
            const email = emailInput.value.trim();
            const domain = domainInput.value.trim();

            // 이메일 유효성 검사 (간단한 정규식)
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isEmailValid = email && emailRegex.test(email);

            // 도메인 유효성 검사
            const isDomainValid = domain && domainInput.checkValidity();

            // 둘 다 유효하면 버튼 활성화
            if (isEmailValid && isDomainValid) {
                registerButton.disabled = false;
            } else {
                registerButton.disabled = true;
            }
        };

        // 입력 필드 변경 시마다 유효성 검사
        emailInput.addEventListener('input', validateInputs);
        domainInput.addEventListener('input', validateInputs);

        // 초기 상태 검사
        validateInputs();

        // ----------------------------------------------------


        registerButton.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const domain = domainInput.value.trim();

            if (!email) {
                showMessage("오류", "이메일을 먼저 입력해주세요.", false);
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage("오류", "유효한 이메일 형식이 아닙니다.<br>예: admin@yourdomain.com", false);
                return;
            }

            if (!domain) {
                showMessage("오류", "도메인을 먼저 입력해주세요.", false);
                return;
            }

            if (domainInput.checkValidity() === false) {
                showMessage("오류", "유효한 도메인 형식이 아닙니다.<br>예: example.com, sub.example.co.kr", false);
                return;
            }

            modalDomainDisplay.textContent = domain;
            registerModal.classList.remove('hidden-modal');
        });

        cancelRegister.addEventListener('click', () => {
            registerModal.classList.add('hidden-modal');
        });

        // ----------------------------------------------------
        // 2. 도메인 등록 확인 및 SSE로 실시간 진행 상황 표시
        // ----------------------------------------------------
        confirmRegister.addEventListener('click', async () => {
            registerModal.classList.add('hidden-modal');
            const email = emailInput.value.trim();
            const domain = domainInput.value.trim();

            // 서버 상태의 "보안:" 영역을 실시간 진행 상황 표시로 사용
            securityStatusDisplay.textContent = '⏳ 도메인 등록을 시작합니다...';
            securityStatusDisplay.classList.remove('status-value-error', 'status-value-success');
            securityStatusDisplay.style.color = '#FFD700'; // 골드 색상

            try {
                // POST로 SSE 스트림 요청 (이메일도 함께 전송)
                const response = await fetch(`${BASE_URL}/apply_security`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: domain,
                        email: email
                    })
                });

                if (!response.ok) {
                    throw new Error(`서버 응답 오류: ${response.status}`);
                }

                // SSE 스트림 읽기
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');

                    // 마지막 불완전한 라인은 버퍼에 보관
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6).trim();
                            if (!jsonStr) continue;

                            try {
                                const data = JSON.parse(jsonStr);

                                // 실시간 진행 상황 업데이트
                                if (data.status === 'progress') {
                                    // 서버 상태의 "보안:" 영역에 실시간 진행 상황 표시
                                    securityStatusDisplay.textContent = `${data.message}`;
                                    securityStatusDisplay.classList.remove('status-value-error', 'status-value-success');
                                    securityStatusDisplay.style.color = '#FFD700'; // 골드 색상

                                    console.log(`[진행 중] ${data.message} (${data.step})`);
                                } else if (data.status === 'success') {
                                    // 성공 시 상태 업데이트
                                    currentDomainDisplay.textContent = domain;
                                    currentDomain = domain;
                                    domainInput.value = currentDomain;

                                    securityStatusDisplay.textContent = '적용 (HTTPS)';
                                    securityStatusDisplay.classList.remove('status-value-error');
                                    securityStatusDisplay.classList.add('status-value-success');
                                    securityStatusDisplay.style.color = ''; // 기본 색상으로 복구

                                    showMessage("등록 완료", data.message, true);
                                    console.log(`[성공] ${data.message}`);
                                    break;
                                } else if (data.status === 'error') {
                                    // 실패 시
                                    securityStatusDisplay.textContent = '미적용 (HTTP)';
                                    securityStatusDisplay.classList.remove('status-value-success');
                                    securityStatusDisplay.classList.add('status-value-error');
                                    securityStatusDisplay.style.color = ''; // 기본 색상으로 복구

                                    showMessage("등록 실패", data.message, false);
                                    console.error(`[실패] ${data.message}`);
                                    break;
                                } else if (data.status === 'warning') {
                                    // 경고 메시지
                                    console.warn(`[경고] ${data.message}`);
                                }
                            } catch (parseError) {
                                console.error("JSON 파싱 오류:", parseError, "원본:", jsonStr);
                            }
                        }
                    }
                }

            } catch (error) {
                showMessage("통신 오류", `❌ 서버와 통신 중 오류 발생: ${error.message}`, false);
                console.error("Fetch 오류:", error);

                // 오류 시 상태 복구
                securityStatusDisplay.textContent = '미적용 (HTTP)';
                securityStatusDisplay.classList.remove('status-value-success');
                securityStatusDisplay.classList.add('status-value-error');
                securityStatusDisplay.style.color = '';
            }
        });

        // ----------------------------------------------------


        releaseButton.addEventListener('click', () => {
            // 현재 등록된 도메인 확인
            const registeredDomain = currentDomainDisplay.textContent.trim();

            if (registeredDomain === '없음' || !registeredDomain) {
                showMessage("오류", "해제할 도메인이 없습니다.<br>먼저 도메인을 등록해주세요.", false);
                return;
            }

            releaseModal.classList.remove('hidden-modal');
        });

        cancelRelease.addEventListener('click', () => {
            releaseModal.classList.add('hidden-modal');
        });

        confirmRelease.addEventListener('click', async () => {
            releaseModal.classList.add('hidden-modal');

            const domainForMessage = currentDomainDisplay.textContent.trim();
            const ipAddress = actualIpDisplay.textContent.trim(); // IP 주소 가져오기

            if (!ipAddress || ipAddress === 'IP 주소 확인 중...' || ipAddress === 'IP 주소 형식 오류') {
                showMessage("오류", "유효한 IP 주소를 가져올 수 없습니다. 페이지를 새로고침하거나 잠시 후 다시 시도해주세요.", false);
                return;
            }

            // 서버 상태의 "보안:" 영역을 실시간 진행 상황 표시로 사용
            securityStatusDisplay.textContent = '⏳ 도메인 해제를 시작합니다...';
            securityStatusDisplay.classList.remove('status-value-error', 'status-value-success');
            securityStatusDisplay.style.color = '#FFD700'; // 골드 색상

            try {
                // POST로 SSE 스트림 요청
                const response = await fetch(`${BASE_URL}/release_security`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ip: ipAddress })
                });

                if (!response.ok) {
                    throw new Error(`서버 응답 오류: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');

                    // 마지막 불완전한 라인은 버퍼에 보관
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6).trim();
                            if (!jsonStr) continue;

                            try {
                                const data = JSON.parse(jsonStr);

                                // 실시간 진행 상황 업데이트
                                if (data.status === 'progress') {
                                    // 서버 상태의 "보안:" 영역에 실시간 진행 상황 표시
                                    securityStatusDisplay.textContent = `${data.message}`;
                                    securityStatusDisplay.classList.remove('status-value-error', 'status-value-success');
                                    securityStatusDisplay.style.color = '#FFD700'; // 골드 색상

                                    console.log(`[진행 중] ${data.message} (${data.step})`);
                                } else if (data.status === 'success') {
                                    // 성공 시 상태 업데이트
                                    currentDomainDisplay.textContent = '없음';
                                    currentDomain = '';
                                    domainInput.value = '';

                                    securityStatusDisplay.textContent = '미적용 (HTTP)';
                                    securityStatusDisplay.classList.remove('status-value-success');
                                    securityStatusDisplay.classList.add('status-value-error');
                                    securityStatusDisplay.style.color = ''; // 기본 색상으로 복구

                                    showMessage("해제 완료", data.message, true);
                                    console.log(`[성공] ${data.message}`);
                                    break;
                                } else if (data.status === 'error') {
                                    // 실패 시
                                    securityStatusDisplay.style.color = ''; // 기본 색상으로 복구

                                    showMessage("해제 실패", data.message, false);
                                    console.error(`[실패] ${data.message}`);
                                    break;
                                } else if (data.status === 'warning') {
                                    // 경고 메시지
                                    console.warn(`[경고] ${data.message}`);
                                }
                            } catch (parseError) {
                                console.error("JSON 파싱 오류:", parseError, "원본:", jsonStr);
                            }
                        }
                    }
                }

            } catch (error) {
                showMessage("통신 오류", `❌ 서버와 통신 중 오류 발생: ${error.message}`, false);
                console.error("Fetch 오류:", error);

                // 오류 시 상태 복구
                securityStatusDisplay.style.color = '';
            }
        });

        console.log("도메인 및 보안 관리 페이지 로드됨.");
    });
</script>
{% endblock %}