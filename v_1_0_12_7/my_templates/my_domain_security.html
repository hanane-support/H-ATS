{% extends "my_base.html" %}

{% block title %}ë„ë©”ì¸ ë° ë³´ì•ˆ - H-ATS Admin{% endblock %}

{% block page_header %}ë„ë©”ì¸ ë° ë³´ì•ˆ ê´€ë¦¬{% endblock %}

{% block content %}

<div class="card domain-security-card">
    <h2 class="card-title">ë„ë©”ì¸ ë° ë³´ì•ˆ ì •ë³´</h2>
    <p class="security-recommendation-text">
        <span class="security-text-span">
            HTTP ëŠ” ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•˜ì§€ ì•Šê³  ì „ì†¡í•˜ì§€ë§Œ, HTTPS ëŠ” SSL/TLS ë¡œ ë°ì´í„°ë¥¼ ì•”í˜¸í™”í•´ ë³´ì•ˆì„ ê°•í™”í•©ë‹ˆë‹¤.
            <br>HTTPS ë³´ì•ˆì„ ì ìš©í•˜ê¸° ìœ„í•´ ë„ë©”ì¸ ë“±ë¡ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
        </span>
    </p>
    <hr class="card-hr">

    <h3 class="section-header">ì„œë²„ ìƒíƒœ</h3>

    <div class="status-box">
        <div class="status-content">
            <p>
                <span class="status-label">HOME IP :</span>
                <span class="status-value-ip">{{ my_ip }}</span>
            </p>

            <p>
                <span class="status-label">VULTR IP :</span>
                <span class="status-value-ip">{{ vultr_ip }}</span>
            </p>

            <p>
                <span class="status-label">ë„ë©”ì¸ :</span>
                <span class="status-value" id="currentDomainDisplay">{{ domain_name | default('ì—†ìŒ') }}</span>
            </p>

            <p>
                <span class="status-label">ë³´ì•ˆ :</span>
                <span id="securityStatusDisplay"
                    class="{% if security_status == 'HTTPS' %}status-value-success{% else %}status-value-error{% endif %}">
                    {% if security_status == 'HTTPS' %}
                    ì ìš© (HTTPS)
                    {% else %}
                    ë¯¸ì ìš© (HTTP)
                    {% endif %}
                </span>
            </p>
        </div>
    </div>

    <h3 class="section-header">ì´ë©”ì¼ ë“±ë¡ <span class="required-mark">(í•„ìˆ˜)</span></h3>

    <div class="info-box">
        <p class="info-text">
            <strong>ì´ë©”ì¼ì„ ë“±ë¡í•´ì•¼ í•˜ëŠ” ì´ìœ :</strong>
        </p>
        <ul class="info-list">
            <li>ì¸ì¦ì„œ ë§Œë£Œ ì•Œë¦¼ ìˆ˜ì‹  (30ì¼ ì „, 7ì¼ ì „)</li>
            <li>ACME ê³„ì • ë³µêµ¬ ë° ê´€ë¦¬</li>
            <li>ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬ ì‹œ ê¸´ê¸‰ ì—°ë½</li>
        </ul>
    </div>

    <div>
        <input type="email" id="email-input" placeholder="admin@example.com" class="email-input"
            title="ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œ (ì˜ˆ: admin@yourdomain.com)" value="{{ email | default('', true) }}">
    </div>

    <h3 class="section-header">ë„ë©”ì¸ ê´€ë¦¬ <span class="required-mark">(í•„ìˆ˜)</span></h3>

    <div>
        <input type="text" id="domain-input" placeholder="example.com (ì˜ë¬¸ ë„ë©”ì¸ ê¶Œì¥)" class="domain-input"
            pattern="^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,63}$"
            title="ìœ íš¨í•œ ë„ë©”ì¸ í˜•ì‹ (ì˜ˆ: example.com, sub.example.co.kr)">

        <div class="button-group">
            <button id="registerDomainButton" class="small-button accent-color-bg full-width-button" disabled>ë„ë©”ì¸
                ë“±ë¡</button>

            <button id="releaseDomainButton" class="small-button delete-button full-width-button" disabled>ë„ë©”ì¸ í•´ì œ</button>
        </div>
    </div>
</div>

<div id="registerDomainModal" class="modal-overlay hidden-modal">
    <div class="modal-content">
        <h3 class="modal-header-danger">ë„ë©”ì¸ ë“±ë¡ í™•ì¸</h3>
        <p class="modal-text">
            (<span id="modal-domain-display"></span>) ì„ ë„ë©”ì¸ìœ¼ë¡œ ë“±ë¡í•©ë‹ˆë‹¤. <br><br>
            <span class="modal-text-success">ë“±ë¡ í›„ SSL/TLS ë³´ì•ˆ ì ìš©ì´ ì‹œì‘ë©ë‹ˆë‹¤.</span>
        </p>
        <div class="modal-actions">
            <button id="confirmRegisterDomain" class="small-button accent-color-bg">
                ë“±ë¡
            </button>
            <button id="cancelRegisterDomain" class="small-button secondary-color-bg">
                ì·¨ì†Œ
            </button>
        </div>
    </div>
</div>

<div id="releaseDomainModal" class="modal-overlay hidden-modal">
    <div class="modal-content">
        <h3 class="modal-header-danger">ë„ë©”ì¸ í•´ì œ í™•ì¸</h3>
        <p class="modal-text">
            ë„ë©”ì¸ì„ í•´ì œí•˜ê³  IP (HTTP) ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. <br>
        </p>
        <p class="modal-text-danger">
            ë³´ì•ˆì´ ì·¨ì•½í•´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
        <div class="modal-actions">
            <button id="confirmReleaseDomain" class="small-button delete-button-confirm">
                í•´ì œ
            </button>
            <button id="cancelReleaseDomain" class="small-button secondary-color-bg">
                ì·¨ì†Œ
            </button>
        </div>
    </div>
</div>

<div id="messageModal" class="modal-overlay hidden-modal">
    <div class="modal-content">
        <h3 id="messageModalHeader" class="modal-header-danger"></h3>
        <p id="messageModalText" class="modal-text"></p>
        <div class="modal-actions">
            <button id="closeMessageModal" class="small-button secondary-color-bg">
                í™•ì¸
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head_styles %}
<style>
    .card {
        background-color: var(--header-bg-dark);
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        border: 1px solid var(--border-color-dark);
    }

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .hidden-modal {
        display: none !important;
    }

    .modal-content {
        background-color: var(--header-bg-dark);
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        border: 1px solid var(--border-color-dark);
        max-width: 400px;
        width: 90%;
        text-align: center;
    }

    /* Modal Headers */
    .modal-header-danger {
        color: var(--accent-color);
        font-size: 1.5em;
        /* font-weight: bold; */
        margin-bottom: 30px;
        margin-top: 0;
    }

    /* Success Header for general messages */
    .modal-header-success {
        color: #8BC34A;
        /* status-value-success color */
        font-size: 1.5em;
        /* font-weight: bold; */
        margin-bottom: 30px;
        margin-top: 0;
    }

    #releaseDomainModal .modal-header-danger {
        color: #ff4d4d;
    }

    .modal-text {
        color: var(--text-color-light);
        margin-bottom: 15px;
        line-height: 1.4;
        font-size: 1em;
    }

    .modal-text-success {
        color: #83ff52;
        /* font-weight: bold; */
    }

    .modal-text-danger {
        color: #ff4d4d;
        /* font-weight: bold; */
        margin-bottom: 25px;
        font-size: 1em;
    }

    .modal-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 30px;
    }

    .card-title {
        color: var(--subtitle-color);
        margin-top: 0;
        margin-bottom: 10px;
        font-size: 1.5em;
    }

    .security-recommendation-text {
        color: var(--text-color-light);
        margin-top: 5px;
        margin-bottom: 15px;
        line-height: 1.4;
    }

    .card-hr {
        border: 0;
        height: 1px;
        background-color: var(--border-color-dark);
        margin-top: 20px;
        margin-bottom: 30px;
    }

    .section-header {
        color: var(--text-color-light);
        margin-top: 35px;
        margin-bottom: 10px;
        font-size: 1.2em;
        /* font-weight: bold; */
    }

    .status-box {
        margin-top: 0;
        padding: 20px;
        border: 1px solid var(--border-color-dark);
        border-radius: 8px;
        background-color: var(--sidebar-bg-dark);
    }

    .status-content p {
        margin: 12px 0;
        line-height: 1.2;
    }

    .status-label {
        /* font-weight: bold; */
        color: var(--text-color-light);
        display: inline-block;
        width: 80px;
    }

    .status-value {
        color: var(--text-color-dark);
    }

    .status-value-ip {
        color: #fffb00;
        font-size: 1.1em;
    }

    .status-value-success {
        color: #22ff00;
    }

    .status-value-error {
        color: #EF5350;
    }

    .required-mark {
        color: #EF5350;
        font-size: 0.9em;
        font-weight: normal;
    }

    .info-box {
        background-color: #1a2332;
        border: 1px solid #2a3f5f;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .info-text {
        color: var(--text-color-light);
        margin: 0 0 10px 0;
        font-size: 0.95em;
    }

    .info-list {
        color: var(--text-color-dark);
        margin: 0;
        padding-left: 20px;
        font-size: 0.9em;
        line-height: 1.6;
    }

    .info-list li {
        margin-bottom: 5px;
    }

    .email-input {
        width: 100%;
        padding: 12px;
        margin-top: 0;
        margin-bottom: 25px;
        border: 1px solid #444;
        border-radius: 6px;
        background-color: var(--sidebar-bg-dark);
        color: var(--text-color-light);
        font-size: 1em;
        box-sizing: border-box;
    }

    .email-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .domain-input {
        width: 100%;
        padding: 12px;
        margin-top: 0;
        margin-bottom: 25px;
        border: 1px solid #444;
        border-radius: 6px;
        background-color: var(--sidebar-bg-dark);
        color: var(--text-color-light);
        font-size: 1em;
        box-sizing: border-box;
    }

    .domain-input:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 0px;
    }

    .small-button {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        /* font-weight: bold; */
        transition: background-color 0.3s, opacity 0.3s;
        color: var(--text-color-light);
        font-size: 1em;
        flex-grow: 1;
    }

    .small-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .accent-color-bg {
        background-color: var(--accent-color);
    }

    .accent-color-bg:hover {
        background-color: #0056b3;
    }

    .secondary-color-bg {
        background-color: #6c757d;
        color: white;
    }

    .secondary-color-bg:hover {
        background-color: #5a6268;
    }

    .delete-button {
        background-color: #dc3545;
        color: white;
    }

    .delete-button:hover {
        background-color: #c82333;
    }

    .delete-button-confirm {
        background-color: #dc3545;
        color: white;
    }

    .delete-button-confirm:hover {
        background-color: #c82333;
    }

    .full-width-button {
        padding: 10px 20px;
        border-radius: 6px;
    }
</style>
{% endblock %}

{% block page_script %}
<script>
    // Flask/FastAPI í™˜ê²½ì—ì„œ ì‚¬ìš©ë  Base URLì„ ì •ì˜í•©ë‹ˆë‹¤.
    const BASE_URL = '/admin/domain_security';

    // ë“±ë¡ ì„±ê³µ ì‹œ ê°’ì„ ìœ ì§€í•˜ê¸° ìœ„í•œ ë³€ìˆ˜
    let currentDomain = '';
    let currentEmail = '';

    document.addEventListener('DOMContentLoaded', () => {
        const registerButton = document.getElementById('registerDomainButton');
        const registerModal = document.getElementById('registerDomainModal');
        const confirmRegister = document.getElementById('confirmRegisterDomain');
        const cancelRegister = document.getElementById('cancelRegisterDomain');
        const releaseButton = document.getElementById('releaseDomainButton');
        const releaseModal = document.getElementById('releaseDomainModal');
        const confirmRelease = document.getElementById('confirmReleaseDomain');
        const cancelRelease = document.getElementById('cancelReleaseDomain');
        const emailInput = document.getElementById('email-input');
        const domainInput = document.getElementById('domain-input');
        const modalDomainDisplay = document.getElementById('modal-domain-display');

        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ ìš”ì†Œ
        const currentDomainDisplay = document.getElementById('currentDomainDisplay');
        const securityStatusDisplay = document.getElementById('securityStatusDisplay');

        // VULTR IP ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° (ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ê°’)
        const vultrIpElements = document.querySelectorAll('.status-value-ip');
        const vultrIpDisplay = vultrIpElements.length >= 2 ? vultrIpElements[1] : null;

        // ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ëª¨ë‹¬ ìš”ì†Œ
        const messageModal = document.getElementById('messageModal');
        const messageModalHeader = document.getElementById('messageModalHeader');
        const messageModalText = document.getElementById('messageModalText');
        const closeMessageModal = document.getElementById('closeMessageModal');

        // alert()ë¥¼ ëŒ€ì²´í•˜ëŠ” ë©”ì‹œì§€ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
        const showMessage = (header, text, isSuccess = true) => {
            messageModalHeader.textContent = header;
            messageModalText.innerHTML = text; // HTMLì„ ì‚¬ìš©í•˜ë¯€ë¡œ innerHTML ì‚¬ìš©

            // í—¤ë” ìƒ‰ìƒ/í´ë˜ìŠ¤ ì„¤ì •
            messageModalHeader.classList.remove('modal-header-danger', 'modal-header-success');
            if (isSuccess) {
                messageModalHeader.classList.add('modal-header-success');
            } else {
                messageModalHeader.classList.add('modal-header-danger');
            }

            messageModal.classList.remove('hidden-modal');
        };

        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê¸°ë³¸ ë™ì‘: ëª¨ë‹¬ ìˆ¨ê¹€)
        closeMessageModal.addEventListener('click', () => {
            messageModal.classList.add('hidden-modal');
            // ë“±ë¡ ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë¦¬ìŠ¤ë„ˆê°€ ê±¸ë ¤ìˆë‹¤ë©´ ì œê±°í•©ë‹ˆë‹¤.
            closeMessageModal.removeEventListener('click', handlePostRegisterAction);
        });

        // ----------------------------------------------------
        // ì´ˆê¸° ìƒíƒœ ë™ê¸°í™”: ì„œë²„ì—ì„œ ë Œë”ë§ëœ ë„ë©”ì¸ ê°’ì„ ê°€ì ¸ì™€ ì…ë ¥ í•„ë“œì™€ JS ë³€ìˆ˜ì— ë°˜ì˜í•©ë‹ˆë‹¤.
        const initialDomainText = currentDomainDisplay.textContent.trim();
        if (initialDomainText !== 'ì—†ìŒ' && initialDomainText !== '') {
            currentDomain = initialDomainText;
            domainInput.value = currentDomain;
        }

        // ì´ë©”ì¼ í•„ë“œ ì´ˆê¸°í™”
        const initialEmailText = emailInput.value.trim();
        if (initialEmailText) {
            currentEmail = initialEmailText;
            emailInput.value = currentEmail;
        }
        // ----------------------------------------------------

        // VULTR IPëŠ” ì„œë²„ì—ì„œ ë Œë”ë§ë˜ë¯€ë¡œ ë³„ë„ì˜ fetchê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

        // ----------------------------------------------------
        // ì´ë©”ì¼ ë° ë„ë©”ì¸ ìœ íš¨ì„± ê²€ì‚¬ ë° ë²„íŠ¼ í™œì„±í™”
        // ----------------------------------------------------

        const validateInputs = () => {
            const email = emailInput.value.trim();
            const domain = domainInput.value.trim();

            // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì‚¬ (ê°„ë‹¨í•œ ì •ê·œì‹)
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const isEmailValid = email && emailRegex.test(email);

            // ë„ë©”ì¸ ìœ íš¨ì„± ê²€ì‚¬
            const isDomainValid = domain && domainInput.checkValidity();

            // ë‘˜ ë‹¤ ìœ íš¨í•˜ë©´ ë“±ë¡ ë²„íŠ¼ í™œì„±í™”
            if (isEmailValid && isDomainValid) {
                registerButton.disabled = false;
            } else {
                registerButton.disabled = true;
            }
        };

        // ë„ë©”ì¸ í•´ì œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        const updateReleaseButtonState = () => {
            // í˜„ì¬ ë„ë©”ì¸ì´ ë“±ë¡ë˜ì–´ ìˆê³  HTTPS ìƒíƒœì¼ ë•Œë§Œ í™œì„±í™”
            const hasDomain = currentDomain && currentDomain !== '' && currentDomain !== 'ì—†ìŒ';
            const isHttps = securityStatusDisplay.textContent.includes('HTTPS') ||
                           securityStatusDisplay.textContent.includes('ì ìš©');

            // ì…ë ¥ í•„ë“œë„ í™•ì¸
            const hasEmailInput = emailInput.value.trim() !== '';
            const hasDomainInput = domainInput.value.trim() !== '';

            if (hasDomain && isHttps && hasEmailInput && hasDomainInput) {
                releaseButton.disabled = false;
            } else {
                releaseButton.disabled = true;
            }

            console.log(`ğŸ” í•´ì œ ë²„íŠ¼ ìƒíƒœ: ë„ë©”ì¸=${currentDomain}, HTTPS=${isHttps}, ì´ë©”ì¼ì…ë ¥=${hasEmailInput}, ë„ë©”ì¸ì…ë ¥=${hasDomainInput}, í™œì„±í™”=${!releaseButton.disabled}`);
        };

        // ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œë§ˆë‹¤ ìœ íš¨ì„± ê²€ì‚¬ ë° í•´ì œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        emailInput.addEventListener('input', () => {
            validateInputs();
            updateReleaseButtonState();
        });
        domainInput.addEventListener('input', () => {
            validateInputs();
            updateReleaseButtonState();
        });

        // ì´ˆê¸° ìƒíƒœ ê²€ì‚¬
        validateInputs();
        updateReleaseButtonState();

        // ----------------------------------------------------


        registerButton.addEventListener('click', () => {
            const email = emailInput.value.trim();
            const domain = domainInput.value.trim();

            if (!email) {
                showMessage("ì˜¤ë¥˜", "ì´ë©”ì¼ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.", false);
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage("ì˜¤ë¥˜", "ìœ íš¨í•œ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.<br>ì˜ˆ: admin@yourdomain.com", false);
                return;
            }

            if (!domain) {
                showMessage("ì˜¤ë¥˜", "ë„ë©”ì¸ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.", false);
                return;
            }

            if (domainInput.checkValidity() === false) {
                showMessage("ì˜¤ë¥˜", "ìœ íš¨í•œ ë„ë©”ì¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.<br>ì˜ˆ: example.com, sub.example.co.kr", false);
                return;
            }

            modalDomainDisplay.textContent = domain;
            registerModal.classList.remove('hidden-modal');
        });

        cancelRegister.addEventListener('click', () => {
            registerModal.classList.add('hidden-modal');
        });

        // ----------------------------------------------------
        // 2. ë„ë©”ì¸ ë“±ë¡ í™•ì¸ ë° SSEë¡œ ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© í‘œì‹œ
        // ----------------------------------------------------
        confirmRegister.addEventListener('click', async () => {
            registerModal.classList.add('hidden-modal');
            const email = emailInput.value.trim();
            const domain = domainInput.value.trim();

            // ì„œë²„ ìƒíƒœì˜ "ë³´ì•ˆ:" ì˜ì—­ì„ ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© í‘œì‹œë¡œ ì‚¬ìš©
            securityStatusDisplay.textContent = 'â³ ë„ë©”ì¸ ë“±ë¡ì„ ì‹œì‘í•©ë‹ˆë‹¤...';
            securityStatusDisplay.classList.remove('status-value-error', 'status-value-success');
            securityStatusDisplay.style.color = '#FFD700'; // ê³¨ë“œ ìƒ‰ìƒ

            try {
                // POSTë¡œ SSE ìŠ¤íŠ¸ë¦¼ ìš”ì²­ (ì´ë©”ì¼ë„ í•¨ê»˜ ì „ì†¡)
                const response = await fetch(`${BASE_URL}/apply_security`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: domain,
                        email: email
                    })
                });

                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }

                // SSE ìŠ¤íŠ¸ë¦¼ ì½ê¸°
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');

                    // ë§ˆì§€ë§‰ ë¶ˆì™„ì „í•œ ë¼ì¸ì€ ë²„í¼ì— ë³´ê´€
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6).trim();
                            if (!jsonStr) continue;

                            try {
                                const data = JSON.parse(jsonStr);

                                // ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                                if (data.status === 'progress') {
                                    // ì„œë²„ ìƒíƒœì˜ "ë³´ì•ˆ:" ì˜ì—­ì— ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© í‘œì‹œ
                                    securityStatusDisplay.textContent = `${data.message}`;
                                    securityStatusDisplay.classList.remove('status-value-error', 'status-value-success');
                                    securityStatusDisplay.style.color = '#FFD700'; // ê³¨ë“œ ìƒ‰ìƒ

                                    console.log(`[ì§„í–‰ ì¤‘] ${data.message} (${data.step})`);
                                } else if (data.status === 'success') {
                                    // ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                                    currentDomainDisplay.textContent = domain;
                                    currentDomain = domain;
                                    domainInput.value = currentDomain;

                                    currentEmail = email;
                                    emailInput.value = currentEmail;

                                    securityStatusDisplay.textContent = 'ì ìš© (HTTPS)';
                                    securityStatusDisplay.classList.remove('status-value-error');
                                    securityStatusDisplay.classList.add('status-value-success');
                                    securityStatusDisplay.style.color = ''; // ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ë³µêµ¬

                                    // ë„ë©”ì¸ ë“±ë¡ ì„±ê³µ ì‹œ í•´ì œ ë²„íŠ¼ í™œì„±í™”
                                    updateReleaseButtonState();

                                    showMessage("ë“±ë¡ ì™„ë£Œ", data.message, true);
                                    console.log(`[ì„±ê³µ] ${data.message}`);
                                    break;
                                } else if (data.status === 'error') {
                                    // ì‹¤íŒ¨ ì‹œ
                                    securityStatusDisplay.textContent = 'ë¯¸ì ìš© (HTTP)';
                                    securityStatusDisplay.classList.remove('status-value-success');
                                    securityStatusDisplay.classList.add('status-value-error');
                                    securityStatusDisplay.style.color = ''; // ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ë³µêµ¬

                                    showMessage("ë“±ë¡ ì‹¤íŒ¨", data.message, false);
                                    console.error(`[ì‹¤íŒ¨] ${data.message}`);
                                    break;
                                } else if (data.status === 'warning') {
                                    // ê²½ê³  ë©”ì‹œì§€
                                    console.warn(`[ê²½ê³ ] ${data.message}`);
                                }
                            } catch (parseError) {
                                console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", parseError, "ì›ë³¸:", jsonStr);
                            }
                        }
                    }
                }

            } catch (error) {
                showMessage("í†µì‹  ì˜¤ë¥˜", `âŒ ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, false);
                console.error("Fetch ì˜¤ë¥˜:", error);

                // ì˜¤ë¥˜ ì‹œ ìƒíƒœ ë³µêµ¬
                securityStatusDisplay.textContent = 'ë¯¸ì ìš© (HTTP)';
                securityStatusDisplay.classList.remove('status-value-success');
                securityStatusDisplay.classList.add('status-value-error');
                securityStatusDisplay.style.color = '';
            }
        });

        // ----------------------------------------------------


        releaseButton.addEventListener('click', () => {
            // í˜„ì¬ ë“±ë¡ëœ ë„ë©”ì¸ í™•ì¸
            const registeredDomain = currentDomainDisplay.textContent.trim();

            if (registeredDomain === 'ì—†ìŒ' || !registeredDomain) {
                showMessage("ì˜¤ë¥˜", "í•´ì œí•  ë„ë©”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë¨¼ì € ë„ë©”ì¸ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.", false);
                return;
            }

            releaseModal.classList.remove('hidden-modal');
        });

        cancelRelease.addEventListener('click', () => {
            releaseModal.classList.add('hidden-modal');
        });

        confirmRelease.addEventListener('click', async () => {
            releaseModal.classList.add('hidden-modal');

            const domainForMessage = currentDomainDisplay.textContent.trim();

            // VULTR IP ê°€ì ¸ì˜¤ê¸°
            const ipAddress = vultrIpDisplay ? vultrIpDisplay.textContent.trim() : '{{ vultr_ip }}';

            if (!ipAddress || ipAddress === 'í™•ì¸ ì¤‘...' || ipAddress === '') {
                showMessage("ì˜¤ë¥˜", "ìœ íš¨í•œ IP ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", false);
                return;
            }

            console.log(`ğŸ” ë„ë©”ì¸ í•´ì œ ìš”ì²­: VULTR IP = ${ipAddress}`);

            // ì„œë²„ ìƒíƒœì˜ "ë³´ì•ˆ:" ì˜ì—­ì„ ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© í‘œì‹œë¡œ ì‚¬ìš©
            securityStatusDisplay.textContent = 'â³ ë„ë©”ì¸ í•´ì œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...';
            securityStatusDisplay.classList.remove('status-value-error', 'status-value-success');
            securityStatusDisplay.style.color = '#FFD700'; // ê³¨ë“œ ìƒ‰ìƒ

            try {
                // POSTë¡œ SSE ìŠ¤íŠ¸ë¦¼ ìš”ì²­
                const response = await fetch(`${BASE_URL}/release_security`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ip: ipAddress })
                });

                if (!response.ok) {
                    throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');

                    // ë§ˆì§€ë§‰ ë¶ˆì™„ì „í•œ ë¼ì¸ì€ ë²„í¼ì— ë³´ê´€
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6).trim();
                            if (!jsonStr) continue;

                            try {
                                const data = JSON.parse(jsonStr);

                                // ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                                if (data.status === 'progress') {
                                    // ì„œë²„ ìƒíƒœì˜ "ë³´ì•ˆ:" ì˜ì—­ì— ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© í‘œì‹œ
                                    securityStatusDisplay.textContent = `${data.message}`;
                                    securityStatusDisplay.classList.remove('status-value-error', 'status-value-success');
                                    securityStatusDisplay.style.color = '#FFD700'; // ê³¨ë“œ ìƒ‰ìƒ

                                    console.log(`[ì§„í–‰ ì¤‘] ${data.message} (${data.step})`);
                                } else if (data.status === 'success') {
                                    // ì„±ê³µ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                                    currentDomainDisplay.textContent = 'ì—†ìŒ';
                                    currentDomain = '';
                                    domainInput.value = '';

                                    // ì´ë©”ì¼ë„ ì´ˆê¸°í™”
                                    currentEmail = '';
                                    emailInput.value = '';

                                    securityStatusDisplay.textContent = 'ë¯¸ì ìš© (HTTP)';
                                    securityStatusDisplay.classList.remove('status-value-success');
                                    securityStatusDisplay.classList.add('status-value-error');
                                    securityStatusDisplay.style.color = ''; // ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ë³µêµ¬

                                    // ë„ë©”ì¸ í•´ì œ ì„±ê³µ ì‹œ í•´ì œ ë²„íŠ¼ ë¹„í™œì„±í™”
                                    updateReleaseButtonState();

                                    showMessage("í•´ì œ ì™„ë£Œ", data.message, true);
                                    console.log(`[ì„±ê³µ] ${data.message}`);
                                    break;
                                } else if (data.status === 'error') {
                                    // ì‹¤íŒ¨ ì‹œ
                                    securityStatusDisplay.style.color = ''; // ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ë³µêµ¬

                                    showMessage("í•´ì œ ì‹¤íŒ¨", data.message, false);
                                    console.error(`[ì‹¤íŒ¨] ${data.message}`);
                                    break;
                                } else if (data.status === 'warning') {
                                    // ê²½ê³  ë©”ì‹œì§€
                                    console.warn(`[ê²½ê³ ] ${data.message}`);
                                }
                            } catch (parseError) {
                                console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", parseError, "ì›ë³¸:", jsonStr);
                            }
                        }
                    }
                }

            } catch (error) {
                showMessage("í†µì‹  ì˜¤ë¥˜", `âŒ ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, false);
                console.error("Fetch ì˜¤ë¥˜:", error);

                // ì˜¤ë¥˜ ì‹œ ìƒíƒœ ë³µêµ¬
                securityStatusDisplay.style.color = '';
            }
        });

        console.log("ë„ë©”ì¸ ë° ë³´ì•ˆ ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œë¨.");
    });
</script>
{% endblock %}