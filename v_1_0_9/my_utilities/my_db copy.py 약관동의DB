# C:\Python\MY_PROJECT\v_1_0_9\my_utilities\my_db.py

import sqlite3
import os
from typing import Optional, Tuple

# DB 파일 경로 설정
DB_FILE = os.path.join(os.path.dirname(os.path.abspath(__file__)), '..', 'admin_config.db')

def get_db_connection():
    """SQLite DB 연결 객체를 반환합니다."""
    # FastAPI의 비동기 환경에서 thread-safe하게 사용하기 위해 check_same_thread=False 설정
    conn = sqlite3.connect(DB_FILE, check_same_thread=False)
    return conn

def init_db():
    """DB 파일이 없거나 테이블이 없으면 생성합니다."""
    conn = get_db_connection()
    cursor = conn.cursor()
    
    # 'admin' 테이블 생성
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS admin (
            id TEXT PRIMARY KEY,
            password_hash TEXT NOT NULL
        )
    """)
    
    # ★ 변경: 최초 실행 시 'admin' ID를 삽입하는 로직을 제거합니다.
        
    conn.commit()
    conn.close()

# -------------------------------------------------------------
# ID 관리 함수
# -------------------------------------------------------------

def get_admin_hash(admin_id: str) -> Optional[str]:
    """주어진 ID의 저장된 비밀번호 해시 값을 조회합니다."""
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT password_hash FROM admin WHERE id = ?", (admin_id,))
    result = cursor.fetchone()
    conn.close()
    
    if result:
        return result[0]
    return None

def create_admin_id(admin_id: str, password_hash: str) -> bool:
    """
    새로운 관리자 ID와 비밀번호 해시를 DB에 삽입합니다.
    ID가 이미 존재하면 업데이트합니다. (UPSERT 역할)
    """
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        # ID가 존재하면 업데이트, 없으면 삽입 (UPSERT 역할)
        cursor.execute(
            "INSERT OR REPLACE INTO admin (id, password_hash) VALUES (?, ?)",
            (admin_id, password_hash)
        )
        conn.commit()
        return True
    except sqlite3.Error:
        return False
    finally:
        conn.close()

# ★ 추가: ID 중복 체크 함수
def check_admin_id_exists(admin_id: str) -> bool:
    """
    주어진 ID가 'admin' 테이블에 이미 존재하는지 확인합니다.
    """
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(id) FROM admin WHERE id = ?", (admin_id,))
    count = cursor.fetchone()[0]
    conn.close()
    return count > 0

# ★ 추가: ID 업데이트 함수
def update_admin_id(old_id: str, new_id: str) -> bool:
    """
    기존 ID를 새 ID로 변경합니다.
    """
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        # 기존 ID를 새 ID로 변경하는 쿼리 실행
        cursor.execute(
            "UPDATE admin SET id = ? WHERE id = ?",
            (new_id, old_id)
        )
        conn.commit()
        # 변경된 행이 1개 이상인지 확인하여 성공 여부를 반환합니다.
        return cursor.rowcount > 0
    except sqlite3.IntegrityError as e:
        # 새 ID가 이미 존재하는 경우 (PRIMARY KEY 제약 조건 위반)
        print(f"ID 변경 실패: 새 ID({new_id})가 이미 존재합니다. {e}")
        return False
    except sqlite3.Error as e:
        print(f"DB ID 업데이트 오류: {e}")
        return False
    finally:
        conn.close()

# ★ 새로 추가된 함수: 관리자 ID 삭제 함수
def delete_admin_id(admin_id: str) -> bool:
    """
    주어진 ID를 'admin' 테이블에서 삭제합니다.
    """
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        cursor.execute(
            "DELETE FROM admin WHERE id = ?",
            (admin_id,)
        )
        conn.commit()
        # 삭제된 행이 1개 이상인지 확인하여 성공 여부를 반환합니다.
        return cursor.rowcount > 0
    except sqlite3.Error as e:
        print(f"DB ID 삭제 오류: {e}")
        return False
    finally:
        conn.close()

def get_unconfigured_admin_id() -> Optional[str]:
    """
    ★ 변경: 최초 설정 여부만 확인합니다. 테이블에 레코드가 하나도 없으면 설정되지 않은 것으로 간주합니다.
    """
    conn = get_db_connection()
    cursor = conn.cursor()
    # 테이블에 저장된 레코드 개수를 셉니다.
    cursor.execute("SELECT COUNT(id) FROM admin")
    count = cursor.fetchone()[0]
    conn.close()
    
    # 레코드가 0개이면 최초 설정이 필요함을 의미
    if count == 0:
        return None
    
    # 레코드가 1개 이상이면 이미 설정되었음을 의미
    return 'configured'

# -------------------------------------------------------------
# 전체 관리자 설정 초기화 함수
# -------------------------------------------------------------

def reset_all_admin_passwords():
    """
    ★ 'admin' 테이블의 모든 레코드를 삭제하여 최초 설정 상태로 되돌립니다.
    """
    conn = get_db_connection()
    cursor = conn.cursor()
    
    # 이 쿼리가 실패하는지 확인:
    cursor.execute("DELETE FROM admin")
    
    conn.commit() # ★ 변경사항 반영
    conn.close()  # ★ 연결 종료 (잠금 해제)