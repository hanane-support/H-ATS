{% extends "my_base.html" %}

{% block title %}ì½˜ì†” ì„¤ì • - H-ATS Admin{% endblock %}

{% block page_header %}
    ì½˜ì†” ì„¤ì •
{% endblock %}

{% block content %}
    <div class="settings-grid-container">
        
        <div class="card mb-40">
            <h2>ê´€ë¦¬ì ì•„ì´ë”” ë³€ê²½</h2>
            <p style="color: var(--text-color-dark); margin-top: -15px; margin-bottom: 25px; font-size: 1em;">
                í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ë¥¼ ìƒˆë¡œìš´ ì•„ì´ë””ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
            </p>
            
            <hr style="border: 0; height: 1px; background-color: var(--border-color-dark); margin-top: -10px; margin-bottom: 30px;">
            
            <div class="input-group">
                <label for="current-id">í˜„ì¬ ì•„ì´ë””</label>
                <input type="text" id="current-id" value="{{ user_id }}" readonly 
                        style="cursor: not-allowed; opacity: 0.7; color: var(--accent-color);">
            </div>

            <div class="input-group">
                <label for="new-id">ìƒˆ ì•„ì´ë””</label>
                <input type="text" id="new-id" placeholder="ìƒˆ ì•„ì´ë”” ì…ë ¥">
            </div>
            
            <div class="input-group">
                <label for="id-change-password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="id-change-password" placeholder="ì•„ì´ë”” ë³€ê²½ì„ ìœ„í•œ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            </div>
            
            <div class="info-group">
                <button class="small-button accent-color-bg" id="change-id-btn">ì•„ì´ë”” ë³€ê²½</button>
                <span id="id-change-message" class="ml-20 text-sm"></span>
            </div>
        </div>
        
        <div class="card mb-40">
            <h2>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
            <p style="color: var(--text-color-dark); margin-top: -15px; margin-bottom: 25px; font-size: 1em;">
                ë¹„ë°€ë²ˆí˜¸ëŠ” ì•”í˜¸í™” ë˜ì–´ ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.
            </p>
            
            <hr style="border: 0; height: 1px; background-color: var(--border-color-dark); margin-top: -10px; margin-bottom: 30px;">
            
            <div class="input-group">
                <label for="current-password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="current-password" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            </div>

            <div class="input-group">
                <label for="new-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="new-password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            </div>
            <div class="input-group">
                <label for="confirm-password">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" id="confirm-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥">
            </div>
            
            <div class="info-group">
                <button class="small-button accent-color-bg" id="change-password-btn">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                <span id="password-change-message" class="ml-20 text-sm"></span>
            </div>
        </div>
    </div>
    <div class="card">
        <h2>ê´€ë¦¬ì ê³„ì • ì‚­ì œ</h2>
        <p style="color: var(--text-color-dark); margin-top: -15px; margin-bottom: 25px; font-size: 1em;">
            ê´€ë¦¬ì {{ user_id }} ì„ DBì—ì„œ ì˜êµ¬ ì‚­ì œí•˜ê³  ë¡œê·¸ì•„ì›ƒí•©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </p>
        
        <hr style="border: 0; height: 1px; background-color: var(--border-color-dark); margin-top: -10px; margin-bottom: 30px;">
        
        <div class="info-group">
            <button id="deleteAdminButton" class="delete-button">
                ê´€ë¦¬ì ì‚­ì œ ë° ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>
    </div>
    
    <div id="deleteAdminModal" class="modal-overlay hidden-modal">
        <div class="modal-content">
            <h3 class="modal-header-danger">ğŸš¨ ê´€ë¦¬ì ê³„ì • ì‚­ì œ í™•ì¸</h3>
            <p class="modal-text">
                **ì •ë§ë¡œ í˜„ì¬ ê´€ë¦¬ì ê³„ì •({{ user_id }})ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?**<br>
                ê³„ì •ì´ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë˜ë©°, ì¦‰ì‹œ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.
            </p>
            <p class="modal-text-danger">
                ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </p>
            <div class="modal-actions">
                <button id="cancelDeleteAdmin" class="small-button secondary-color-bg">
                    ì·¨ì†Œ
                </button>
                <button id="confirmDeleteAdmin" class="small-button delete-button-confirm">
                    ì‚­ì œ ì‹¤í–‰
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_head_styles %}
<style>
    /* ğŸŸ¢ 2. 2ë‹¨ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ í¬í•¨ */
    .settings-grid-container {
        display: flex;
        gap: 40px; /* ì¹´ë“œ ì‚¬ì´ì˜ ê°„ê²© */
        margin-bottom: 0px; 
    }
    
    .settings-grid-container .card {
        flex: 1; /* ë‘ ì¹´ë“œê°€ ë™ì¼í•œ ë„ˆë¹„ë¥¼ ê°–ë„ë¡ ì„¤ì • */
        min-width: 0; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); 
        border: 1px solid var(--border-color-dark);
    }
    
    /* í™”ë©´ì´ ì¢ì•„ì§ˆ ê²½ìš° 1ë‹¨ìœ¼ë¡œ ì „í™˜ */
    @media (max-width: 992px) {
        .settings-grid-container {
            flex-direction: column; 
            gap: 20px;
        }
    }
    
    /* ì½˜ì†” ì„¤ì • í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
    .mb-40 { margin-bottom: 40px; } 
    
    .card {
        background-color: var(--header-bg-dark); /* #1e1e1e */
        padding: 30px;
        border-radius: 8px;
    }
    /* â­ï¸â­ï¸ ìˆ˜ì •ëœ ë¶€ë¶„: h2 ìƒ‰ìƒì— var(--subtitle-color) ì ìš© â­ï¸â­ï¸ */
    .card h2 {
        color: var(--subtitle-color); /* var(--accent-color)ì—ì„œ ë³€ê²½ */
        margin-top: 0;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 1.5em;
    }
    /* ì‚­ì œ ì„¹ì…˜ h2 ìƒ‰ìƒ ì˜¤ë²„ë¼ì´ë“œì—ë„ ì ìš© */
    .card:last-child h2 { 
        color: var(--subtitle-color); /* var(--accent-color)ì—ì„œ ë³€ê²½ */
    }

    /* (ì¤‘ëµ: ê¸°ì¡´ì— ì œê³µí–ˆë˜ ë‚˜ë¨¸ì§€ CSS ìŠ¤íƒ€ì¼ ìœ ì§€) */
    .info-group {
        margin-bottom: 15px;
        padding-bottom: 10px;
        display: flex; 
        align-items: center;
    }
    .info-group:last-child {
        border-bottom: none;
    }
    /* ì…ë ¥ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
    .input-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
    }
    .input-group label {
        font-weight: bold;
        color: var(--text-color-light);
        margin-bottom: 8px;
    }
    .input-group input[type="password"],
    .input-group input[type="text"] { 
        padding: 10px;
        border-radius: 4px;
        border: 1px solid var(--border-color-dark);
        background-color: var(--sidebar-bg-dark); /* #222222 */
        color: var(--text-color-light);
        font-size: 1em;
        width: 100%;
        box-sizing: border-box; 
    }

    /* ì½ê¸° ì „ìš© í˜„ì¬ ì•„ì´ë”” ìƒ‰ìƒì„ ë” ë°ì€ íŒŒë€ìƒ‰ìœ¼ë¡œ í‘œì‹œ
       inline styleê°€ ìˆì–´ë„ ìš°ì„ ê¶Œì„ ì£¼ê¸° ìœ„í•´ !important ì‚¬ìš© */
    .input-group input#current-id {
        color: var(--subtitle-color) !important; /* ë°ì€ íŒŒë€ìƒ‰ */
        opacity: 1 !important; /* ì½ê¸°ì „ìš©ìœ¼ë¡œ ë‚®ì•„ì§„ ë¶ˆíˆ¬ëª…ë„ ë³´ì • */
    }
    .small-button {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
        color: var(--text-color-light);
        margin-right: 10px;
        font-size: 1em;
    }
    .accent-color-bg {
        background-color: var(--accent-color); /* #007bff */
    }
    .accent-color-bg:hover {
        background-color: #0056b3;
    }
    .secondary-color-bg {
        background-color: #6c757d; /* Gray */
        color: white; 
    }
    .secondary-color-bg:hover {
        background-color: #5a6268;
    }
    
    /* ê´€ë¦¬ì ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .delete-button {
        width: 100%; 
        display: flex;
        justify-content: center;
        padding: 12px 15px; 
        border: 1px solid #dc3545;
        border-radius: 6px;
        background-color: #dc3545; /* Red */
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
        font-size: 1em; /* ìˆ˜ì •ëœ ë¶€ë¶„ */
    }
    .delete-button:hover {
        background-color: #c82333; /* Darker Red */
    }
    .delete-button-confirm {
        background-color: #dc3545; /* Red */
        color: white;
    }
    .delete-button-confirm:hover {
        background-color: #c82333;
    }
    
    /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
    .text-sm { font-size: 0.875em; }
    .ml-20 { margin-left: 20px; }
    .text-success { color: #28a745; }
    .text-error { color: #dc3545; }
    
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .hidden-modal {
        display: none !important;
    }
    .modal-content {
        background-color: var(--header-bg-dark); /* #1e1e1e */
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        border: 1px solid var(--border-color-dark);
        max-width: 400px;
        width: 90%;
        text-align: center;
    }
    .modal-header-danger {
        color: #dc3545; /* Red */
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 15px;
    }
    .modal-text {
        color: var(--text-color-light);
        margin-bottom: 15px;
        line-height: 1.4;
        font-size: 1em;
    }
    .modal-text-danger {
        color: #dc3545;
        font-weight: bold;
        margin-bottom: 25px;
        font-size: 0.9em;
    }
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
</style>
{% endblock %}

{% block page_script %}
<script>
    // JS ì½”ë“œëŠ” ì´ì „ì— ì œê³µëœ ê²ƒê³¼ ë™ì¼í•˜ë©°, ê¸°ëŠ¥ì ì¸ ë¶€ë¶„ì…ë‹ˆë‹¤.
    document.addEventListener('DOMContentLoaded', () => {
        // --- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì†Œ ---
        const changePasswordBtn = document.getElementById('change-password-btn');
        const currentPasswordInput = document.getElementById('current-password'); 
        const newPasswordInput = document.getElementById('new-password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const passwordChangeMessage = document.getElementById('password-change-message');

        // --- ID ë³€ê²½ ìš”ì†Œ ---
        const changeIdBtn = document.getElementById('change-id-btn');
        const currentIdInput = document.getElementById('current-id');
        const newIdInput = document.getElementById('new-id');
        const idChangePasswordInput = document.getElementById('id-change-password');
        const idChangeMessage = document.getElementById('id-change-message');
        
        // ê´€ë¦¬ì ì‚­ì œ ìš”ì†Œ
        const deleteAdminButton = document.getElementById('deleteAdminButton');
        const deleteAdminModal = document.getElementById('deleteAdminModal');
        const confirmDeleteAdmin = document.getElementById('confirmDeleteAdmin');
        const cancelDeleteAdmin = document.getElementById('cancelDeleteAdmin');
        
        // ==========================================================
        // 1. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë¡œì§
        // ==========================================================
        changePasswordBtn.addEventListener('click', async () => {
            passwordChangeMessage.textContent = ''; 
            const currentPassword = currentPasswordInput.value.trim(); 
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            
            // 1. í”„ë¡ íŠ¸ì—”ë“œ ìœ íš¨ì„± ê²€ì‚¬
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert("ëª¨ë“  ë¹„ë°€ë²ˆí˜¸ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            if (newPassword !== confirmPassword) {
                alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ë€ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            if (currentPassword === newPassword) {
                alert("ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }
            
            // 2. ì„œë²„ë¡œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì²­ ì „ì†¡
            const formData = new FormData();
            formData.append('current_password', currentPassword); 
            formData.append('new_password', newPassword);
            
            try {
                const response = await fetch('/admin/change_password', { 
                    method: 'POST',
                    body: formData 
                });

                const result = await response.json(); 

                if (response.ok) {
                    passwordChangeMessage.textContent = "âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.";
                    passwordChangeMessage.className = 'ml-20 text-sm text-success';
                    
                    currentPasswordInput.value = '';
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    
                } else {
                    passwordChangeMessage.textContent = `âš ï¸ ë³€ê²½ ì‹¤íŒ¨: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                    passwordChangeMessage.className = 'ml-20 text-sm text-error';
                }

            } catch (error) {
                console.error('Fetch error (Change Password):', error);
                passwordChangeMessage.textContent = "ğŸš« ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì—°ê²° ì‹¤íŒ¨.";
                passwordChangeMessage.className = 'ml-20 text-sm text-error';
            }
        });

        // ==========================================================
        // 2. ì•„ì´ë”” ë³€ê²½ ë¡œì§
        // ==========================================================
        changeIdBtn.addEventListener('click', async () => {
            idChangeMessage.textContent = ''; 
            const currentId = currentIdInput.value.trim();
            const newId = newIdInput.value.trim();
            const password = idChangePasswordInput.value.trim();

            // 1. í”„ë¡ íŠ¸ì—”ë“œ ìœ íš¨ì„± ê²€ì‚¬
            if (!currentId || !newId || !password) {
                alert("ëª¨ë“  ì•„ì´ë”” ë° ë¹„ë°€ë²ˆí˜¸ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if (currentId === newId) {
                alert("ìƒˆ ì•„ì´ë””ëŠ” í˜„ì¬ ì•„ì´ë””ì™€ ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }
            if (newId.includes(' ')) {
                alert("ìƒˆ ì•„ì´ë””ì—ëŠ” ê³µë°±ì„ í¬í•¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // 2. ì„œë²„ë¡œ ì•„ì´ë”” ë³€ê²½ ìš”ì²­ ì „ì†¡
            const formData = new FormData();
            formData.append('current_id', currentId);
            formData.append('new_id', newId);
            formData.append('password', password); 

            try {
                const response = await fetch('/admin/change_id', { 
                    method: 'POST',
                    body: formData 
                });

                const result = await response.json(); 

                if (response.ok) {
                    alert(`âœ… ì•„ì´ë””ê°€ ì„±ê³µì ìœ¼ë¡œ '${newId}'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ì„¸ì…˜ì´ ì—…ë°ì´íŠ¸ë˜ì–´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`);
                    
                    newIdInput.value = '';
                    idChangePasswordInput.value = '';
                    
                    window.location.reload(); 
                    
                } else {
                    idChangeMessage.textContent = `âš ï¸ ë³€ê²½ ì‹¤íŒ¨: ${result.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                    idChangeMessage.className = 'ml-20 text-sm text-error';
                    idChangePasswordInput.value = ''; 
                }

            } catch (error) {
                console.error('Fetch error (Change ID):', error);
                idChangeMessage.textContent = "ğŸš« ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì—°ê²° ì‹¤íŒ¨.";
                idChangeMessage.className = 'ml-20 text-sm text-error';
            }
        });
        
        // ==========================================================
        // 3. ê´€ë¦¬ì ì‚­ì œ ë¡œì§
        // ==========================================================

        // ëª¨ë‹¬ í‘œì‹œ
        deleteAdminButton.addEventListener('click', () => {
            deleteAdminModal.classList.remove('hidden-modal');
        });

        // ëª¨ë‹¬ ë‹«ê¸° (ì·¨ì†Œ)
        cancelDeleteAdmin.addEventListener('click', () => {
            deleteAdminModal.classList.add('hidden-modal');
        });

        // ì‚­ì œ ì‹¤í–‰ ë° ì„œë²„ ìš”ì²­
        confirmDeleteAdmin.addEventListener('click', async () => {
            deleteAdminModal.classList.add('hidden-modal');
            
            try {
                const response = await fetch('/admin/delete_admin', {
                    method: 'POST',
                });

                if (response.ok) {
                    alert("âœ… ê´€ë¦¬ì ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    window.location.href = "/admin/login"; 
                } else {
                    let errorMessage = 'ì‚­ì œ ì‹¤íŒ¨: ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜';
                    try {
                        const errorData = await response.json();
                        errorMessage = `âš ï¸ ì‚­ì œ ì‹¤íŒ¨: ${errorData.detail || 'ê´€ë¦¬ì IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}`;
                    } catch (e) {
                        errorMessage = `âš ï¸ ì‚­ì œ ì‹¤íŒ¨ (${response.status}): ì„œë²„ ì‘ë‹µ ì²˜ë¦¬ ë¶ˆê°€.`;
                    }
                    alert(errorMessage);
                }
            } catch (error) {
                alert('ğŸš« ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì ‘ì† ì‹¤íŒ¨: ê³„ì •ì„ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.error('Delete Admin Fetch Error:', error);
            }
        });
        
        console.log("ì½˜ì†” ì„¤ì • í˜ì´ì§€ ë¡œë“œë¨.");
    });
</script>
{% endblock %}