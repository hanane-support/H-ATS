{% extends "my_base.html" %}

{% block title %}HAT Admin - ë„ë©”ì¸ ë° ë³´ì•ˆ{% endblock %}

{% block extra_head_styles %}<style>
        /* my_domain.htmlì—ë§Œ ìˆëŠ” input/button ìŠ¤íƒ€ì¼ */
        .settings-card {
            background-color: var(--header-bg-dark);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .settings-card h2 {
            color: var(--accent-color);
            padding-bottom: 0px; 
            margin-top: 0;
            margin-bottom: 10px; 
        }
        
        .settings-card .description-group {
            border-bottom: 1px solid var(--border-color-dark);
            padding-bottom: 10px; 
            margin-bottom: 20px;
        }
        
        /* \ud83d\udca1 IP ì£¼ì†Œ í‘œì‹œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .ip-display {
            padding: 15px;
            background-color: #2a2a2a;
            border: 1px solid #555;
            border-left: 5px solid #ffeb3b;
            border-radius: 4px;
            margin-bottom: 25px;
            font-size: 0.95em;
        }
        
        .ip-display strong {
            color: #ffeb3b;
            font-size: 1.1em;
            word-break: break-all;
            /* \ud83d\udd27 ìˆ˜ì •: ë³µì‚¬ ê¸°ëŠ¥ì„ ì œê±°í–ˆìœ¼ë¯€ë¡œ ì»¤ì„œ ìŠ¤íƒ€ì¼ë„ ì œê±° */
            /* cursor: pointer; */ 
        }
        
        /* \ud83d\udd27 ìˆ˜ì •: #current-ipì— ì ìš©í–ˆë˜ ì»¤ì„œ ìŠ¤íƒ€ì¼ ì œê±° */
        #current-ip {
            cursor: default; /* ê¸°ë³¸ ì»¤ì„œë¡œ ì„¤ì • */
        }


        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color-light); }
        
        input[type="text"] {
            width: 100%; padding: 10px; border: 1px solid var(--border-color-dark);
            border-radius: 4px; background-color: #333; color: var(--text-color-light);
            box-sizing: border-box; transition: border-color 0.3s;
            font-size: 1.1em; 
        }

        input[type="text"]:focus { border-color: var(--accent-color); outline: none; }

        /* === ë²„íŠ¼ ìŠ¤íƒ€ì¼ (í¬ê¸° ë³µì› ìœ ì§€) === */
        .settings-card button {
            display: block; 
            padding: 10px 18px; 
            background-color: var(--accent-color);
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 1.0em; 
            font-weight: bold; 
            transition: background-color 0.3s; 
            margin-top: 20px; 
            width: auto;
            max-width: 300px; 
        }

        .settings-card button:hover:not(:disabled) { background-color: #0056b3; }
        .settings-card button:disabled { background-color: #555; cursor: not-allowed; }

        /* === ìƒíƒœ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ === */
        .status-message { margin-top: 20px; padding: 10px; border-radius: 4px; display: none; font-size: 1.0em; }
        /* \ud83d\udd14 ìˆ˜ì •: status-pendingì˜ ê¸€ììƒ‰ì„ ëˆˆì´ ë¶€ì‹œì§€ ì•Šì€ í°ìƒ‰(#ddd)ìœ¼ë¡œ ë³€ê²½ */
        .status-pending { background-color: #333; border: 1px solid var(--accent-color); color: #ddd; } 
        /* \ud83d\udd14 ìˆ˜ì •: status-successì˜ ê¸€ììƒ‰ì„ ëˆˆì´ ë¶€ì‹œì§€ ì•Šì€ í°ìƒ‰(#ddd)ìœ¼ë¡œ ë³€ê²½ */
        .status-success { background-color: #1f331f; border: 1px solid #4CAF50; color: #ddd; }
        .status-error { background-color: #5C2828; border: 1px solid #FF5555; color: #EFEFEF; }

        /* === \ud83d\udca1 ë‹¨ê³„ë³„ ë¡œê·¸ ìŠ¤íƒ€ì¼ === */
        #log-container {
            /* âš ï¸ display: none; ì„ ì¶”ê°€í•˜ì—¬ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            display: none; 
            margin-top: 25px; padding: 10px; min-height: 40px; max-height: 200px; overflow-y: auto;
            background-color: #1e1e1e; border: 1px solid var(--border-color-dark);
            border-radius: 4px; font-family: 'Consolas', 'Courier New', monospace; font-size: 0.9em; line-height: 1.4;
        }
        .log-item { color: #e0e0e0; margin-bottom: 5px; }
        .log-initial { color: #999; }
        .log-success { color: #4CAF50; font-weight: bold; }
        .log-error { color: #EFEFEF; font-weight: bold; }
    </style>{% endblock %}

{% block page_header %}ë„ë©”ì¸ ë° ë³´ì•ˆ{% endblock %}

{% block content %}
    <section class="settings-card">
        <h2>ë„ë©”ì¸ ì—°ê²° ë° ë³´ì•ˆ ì ìš© (HTTPS)</h2>

        <div class="description-group">
            <p style="margin-bottom: 10px; color: #ccc;">
                IP ëŒ€ì‹  ì‚¬ìš©í•  ë„ë©”ì¸ì„ ì—°ê²°í•˜ê³ , HTTPS ë³´ì•ˆ ì—°ê²°ë„ í•¨ê»˜ ì ìš©í•©ë‹ˆë‹¤.
                <br>ë„ë©”ì¸ êµ¬ì… ì‚¬ì´íŠ¸ì—ì„œ A ë ˆì½”ë“œ ì„¤ì • í›„ ì§„í–‰í•˜ì„¸ìš”.
            </p>
        </div>

        <div id="ip-display-area" class="ip-display">
            <p style="margin: 0; color: #ddd;">
                ì„œë²„ì˜ í˜„ì¬ ê³µì¸ IPë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...
            </p>
        </div>

        <div class="form-group">
            <label for="domain-name">ë„ë©”ì¸</label>
            <input type="text" id="domain-name" value="{{ domain or '' }}" placeholder="example.com">
        </div>

        <button id="connect-button" onclick="connectMyDomain()">ë„ë©”ì¸ ì—°ê²° ë° ë³´ì•ˆ ì ìš©</button>

        <p id="status-message" class="status-pending status-message"></p>

        <div id="log-container">
            <div class="log-item log-initial">ë¡œê·¸ ì´ˆê¸° ìƒíƒœ: ë„ë©”ì¸ì„ ì…ë ¥í•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‘ì—…ì´ ì‹œì‘ë©ë‹ˆë‹¤.</div>
        </div>

    </section>
{% endblock %}

{% block page_script %}<script>
        // Caddyê°€ reverse_proxyë¡œ ì—°ê²°í•˜ëŠ” FastAPI ì„œë²„ì˜ í¬íŠ¸ (ì‚¬ìš©ì ì •ë³´ ë°˜ì˜)
        const DOMAIN_PORT = 9000; 
        const DOMAIN_STATUS_KEY = 'domainStatus'; 

        // ì„œë²„ë¡œë¶€í„° ì „ë‹¬ëœ ì´ˆê¸° ë„ë©”ì¸ ê°’ (í…œí”Œë¦¿ ë³€ìˆ˜)
        const initialDomain = "{{ domain or '' }}";

        const statusMessage = document.getElementById('status-message');
        const logContainer = document.getElementById('log-container');
        const connectButton = document.querySelector('button[onclick="connectMyDomain()"]');
        const ipDisplayArea = document.getElementById('ip-display-area'); 
        const domainInput = document.getElementById('domain-name');
        
        /* ğŸ’¡ ìˆ˜ì •: copyToClipboard í•¨ìˆ˜ ì œê±° */

        // ìµœì¢… ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ (í•œ ì¤„ í‘œì‹œ)
        function updateStatusMessage(message, type, prefix = 'â³ ì§„í–‰:') {
            statusMessage.textContent = `${prefix} ${message}`;
            statusMessage.className = `status-${type} status-message`;
            statusMessage.style.display = 'block';
            logContainer.innerHTML = ''; 
            logContainer.style.display = 'none';
        }
        
        // Local Storage ì´ˆê¸°í™” í•¨ìˆ˜
        function clearLocalStorage() {
            localStorage.removeItem(DOMAIN_STATUS_KEY);
        }

        // ì„œë²„ í†µì‹  ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ Local Storage ê°’ë§Œ ë¡œë“œ (Caddy statusì™€ ë¬´ê´€í•œ ë©”ì‹œì§€)
        function loadFallbackStatus() {
            const savedStatus = localStorage.getItem(DOMAIN_STATUS_KEY);
            if (savedStatus) {
                try {
                    const statusObj = JSON.parse(savedStatus);
                    updateStatusMessage(statusObj.message, statusObj.type, statusObj.prefix);
                } catch (e) {
                    localStorage.removeItem(DOMAIN_STATUS_KEY);
                }
            } else {
                logContainer.style.display = 'none';
                updateStatusMessage(`í˜„ì¬ Caddy ì„¤ì • ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'pending', 'ğŸ’¡ í™•ì¸ ì¤‘:');
            }
        }
        
        // --- ë©”ì¸ í˜ì´ì§€ ì´ˆê¸°í™” ë¡œì§ ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            let currentIp = 'í™•ì¸ ë¶ˆê°€';
            let caddyExternalPort = '80'; // ê¸°ë³¸ê°’ ì„¤ì •
            let serverAddress = null;

            // 1. my_admin_config.jsonì—ì„œ ì„œë²„ IPì™€ ì™¸ë¶€ í¬íŠ¸ ì •ë³´ ë¡œë“œ
            try {
                const infoResponse = await fetch('/admin/server-info');
                if (infoResponse.ok) {
                    const infoData = await infoResponse.json();
                    currentIp = infoData.ip;
                    caddyExternalPort = infoData.port;
                }
            } catch (error) {
                console.error('ì„œë²„ ì •ë³´ (/admin/server-info) ë¡œë“œ ì¤‘ í†µì‹  ì˜¤ë¥˜:', error);
            }
            
            // 2. IP ì•ˆë‚´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ (my_admin_config.json ì •ë³´ ì‚¬ìš©)
            ipDisplayArea.innerHTML = `
                <p style="margin: 0; color: #ddd;">
                    Vultr ì˜ í˜„ì¬ IP ëŠ” 
                    <strong id="current-ip">${currentIp}</strong> ì´ë©°, 
                    <strong id="current-port">${caddyExternalPort}</strong> í¬íŠ¸ë¡œ
                    ì™¸ë¶€ì—ì„œì˜ ì ‘ê·¼ì„ í—ˆìš©í•©ë‹ˆë‹¤.
                    <br>ë„ë©”ì¸ êµ¬ì… ì‚¬ì´íŠ¸ì—ì„œ
                    <strong id="current-ip">${currentIp}</strong> ê°€
                    A ë ˆì½”ë“œë¡œ ë“±ë¡ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
                </p>
            `;
            
            // 3. Caddyfile ìƒíƒœ í™•ì¸ (ë„ë©”ì¸ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ì—¬ë¶€ ê²°ì •)
            try {
                const statusResponse = await fetch('/admin/caddy-status');
                const serverStatus = await statusResponse.json();
                serverAddress = serverStatus.domain; // ì˜ˆ: "141.164.59.7:80" ë˜ëŠ” "example.com"
            } catch (error) {
                console.error('Caddy ìƒíƒœ ë¡œë“œ ì¤‘ í†µì‹  ì˜¤ë¥˜:', error);
                // í†µì‹  ì˜¤ë¥˜ ì‹œ, ë„ë©”ì¸ ì…ë ¥ í•„ë“œëŠ” DBì— ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©
                if (initialDomain) {
                    domainInput.value = initialDomain;
                } else {
                    domainInput.value = '';
                }
                loadFallbackStatus();
                return;
            }

            // IP ì£¼ì†Œ í˜•íƒœ í™•ì¸ ì •ê·œì‹ (í¬íŠ¸ í¬í•¨ ë˜ëŠ” ë¯¸í¬í•¨)
            const isIpAddressRegex = /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(:\d+)?$/;
            
            if (serverAddress && isIpAddressRegex.test(serverAddress)) {
                // Caddyfileì— IP ì£¼ì†Œ:í¬íŠ¸ í˜•íƒœì¼ ë•Œ (ì„¤ì¹˜ ì§í›„ ìƒíƒœ)
                // DB ê°’ì´ ìˆìœ¼ë©´ ìš°ì„  í‘œì‹œ
                if (initialDomain) {
                    domainInput.value = initialDomain;
                } else {
                    domainInput.value = '';
                }
                clearLocalStorage();
                updateStatusMessage(`í˜„ì¬ ë„ë©”ì¸ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë„ë©”ì¸ì„ ì…ë ¥í•˜ê³  ì—°ê²° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`, 'pending', 'ğŸ’¡ ì¤€ë¹„ ì™„ë£Œ:');

            } else if (serverAddress && serverAddress.includes('.')) {
                // Caddyfileì— ìœ íš¨í•œ ë„ë©”ì¸ì¼ ë•Œ (ì„±ê³µ ìƒíƒœ)
                domainInput.value = serverAddress; // ì„œë²„ì— ì„¤ì •ëœ ë„ë©”ì¸ì„ ìš°ì„  í‘œì‹œ
                
                const successMsg = `Caddyfileì— í˜„ì¬ ë„ë©”ì¸: "${serverAddress}"ì´(ê°€) ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`;
                updateStatusMessage(successMsg, 'success', 'âœ… í˜„ì¬ ì„¤ì •:');
                localStorage.setItem(DOMAIN_STATUS_KEY, JSON.stringify({
                    message: successMsg,
                    type: 'success',
                    prefix: 'âœ… í˜„ì¬ ì„¤ì •:'
                }));
            }
        });


        // ë„ë©”ì¸ ì—°ê²° ê¸°ëŠ¥ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        async function connectMyDomain() {
            
            const domain = domainInput.value.trim();
            
            localStorage.removeItem(DOMAIN_STATUS_KEY); 
            
            if (!domain) {
                console.warn("ë„ë©”ì¸ ì´ë¦„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."); 
                updateStatusMessage("ë„ë©”ì¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'error', 'âŒ ì˜¤ë¥˜:');
                domainInput.focus();
                return;
            }

            // ë„ë©”ì¸ ìœ íš¨ì„± ê²€ì‚¬ (ê°„ë‹¨í•œ ì •ê·œì‹)
            const domainRegex = /^([a-zA-Z0-9\uAC00-\uD7A3-]{1,63}\.)+[a-zA-Z\uAC00-\uD7A3]{2,}$/;
            
            if (!domainRegex.test(domain)) {
                const invalidMsg = `ìœ íš¨í•˜ì§€ ì•Šì€ ë„ë©”ì¸ í˜•ì‹ì…ë‹ˆë‹¤: "${domain}"`;
                console.warn(invalidMsg);
                updateStatusMessage(invalidMsg, 'error', 'âŒ ì‹¤íŒ¨:');
                return; 
            }

            connectButton.disabled = true;
            domainInput.disabled = true;

            const pendingMessage = `ë„ë©”ì¸: "${domain}" (ë‚´ë¶€ í¬íŠ¸: ${DOMAIN_PORT}) ì„¤ì • ì—…ë°ì´íŠ¸ ìš”ì²­ ì „ì†¡ ì¤‘...`;
            updateStatusMessage(pendingMessage, 'pending', 'â³ ì§„í–‰:');
            
            try {
                const response = await fetch("/admin/update-my_domain", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ domain: domain }),
                });

                const result = await response.json();
                
                let finalMessage, finalType, finalPrefix;

                if (response.ok) {
                    finalMessage = `${domain} ë„ë©”ì¸ ì €ì¥ ë° ë³´ì•ˆ ì ìš© ì„±ê³µ.`;
                    finalType = 'success';
                    finalPrefix = 'âœ… ìµœì¢… ì„±ê³µ:';
                    
                    // ì„±ê³µ ì‹œì—ë§Œ ì…ë ¥ í•„ë“œì— ë„ë©”ì¸ ìœ ì§€
                    domainInput.value = domain;
                    
                } else {
                    const errorMessage = result.detail || `HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status}`;
                    finalMessage = `ë„ë©”ì¸ ì„¤ì • ì‹¤íŒ¨: ${errorMessage}`;
                    finalType = 'error';
                    finalPrefix = 'âŒ ìµœì¢… ì‹¤íŒ¨:';
                    
                    // ì‹¤íŒ¨ ì‹œ ì…ë ¥ í•„ë“œ ì¬í™œì„±í™” ë° ê°’ ìœ ì§€ (ì‚¬ìš©ìê°€ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡)
                    domainInput.disabled = false;
                }
                
                updateStatusMessage(finalMessage, finalType, finalPrefix);
                localStorage.setItem(DOMAIN_STATUS_KEY, JSON.stringify({
                    message: finalMessage,
                    type: finalType,
                    prefix: finalPrefix
                }));

            } catch (error) {
                console.error("ë„ë©”ì¸ ì—°ê²° ì¤‘ í†µì‹  ì˜¤ë¥˜ ë°œìƒ:", error);
                const commErrorMsg = "ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. FastAPI ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.";
                
                updateStatusMessage(`í†µì‹  ì˜¤ë¥˜ ë°œìƒ: ${commErrorMsg}`, 'error', 'âŒ í†µì‹  ì˜¤ë¥˜:');
                localStorage.setItem(DOMAIN_STATUS_KEY, JSON.stringify({
                    message: `í†µì‹  ì˜¤ë¥˜ ë°œìƒ: ${commErrorMsg}`,
                    type: 'error',
                    prefix: 'âŒ í†µì‹  ì˜¤ë¥˜:'
                }));
                
                // í†µì‹  ì˜¤ë¥˜ ì‹œ ì…ë ¥ í•„ë“œ ì¬í™œì„±í™” ë° ê°’ ìœ ì§€
                domainInput.disabled = false;

            } finally {
                connectButton.disabled = false;
            }
        }
    </script>
    <script>
        /* ğŸ’¡ ìˆ˜ì •: copyToClipboard í•¨ìˆ˜ê°€ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ window.copyToClipboard ë…¸ì¶œ ë¡œì§ë„ ì œê±° */
    </script>{% endblock %}
